<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Liberty Feedback Kiosk</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0b1020" />
  <style>
    :root {
      --bg-outer: #020716;
      --bg-inner: #05133b;
      --panel-bg: rgba(5, 19, 59, 0.72);
      --panel-border: rgba(80, 140, 255, 0.35);
      --card-bg: rgba(9, 23, 71, 0.65);
      --card-selected: rgba(63, 183, 255, 0.2);
      --text-light: #f5f7ff;
      --text-muted: rgba(245, 247, 255, 0.7);
      --accent: #3fb7ff;
      --accent-strong: #60d7ff;
    }
    * { box-sizing: border-box; }
    html, body {
      height: 100%;
      margin: 0;
      font-family: "Segoe UI", "Roboto", sans-serif;
    }
    body {
      position: relative;
      background: radial-gradient(circle at 20% 20%, rgba(63,183,255,0.25), transparent 55%), linear-gradient(135deg, var(--bg-inner) 0%, var(--bg-outer) 100%);
      color: var(--text-light);
      overflow: hidden;
    }
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: linear-gradient(120deg, rgba(96, 215, 255, 0.08) 0%, transparent 38%, transparent 62%, rgba(96, 215, 255, 0.04) 100%);
      pointer-events: none;
      z-index: 0;
    }
    .wrapper {
      position: relative;
      z-index: 1;
      height: 100%;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 48px 20px;
      gap: 32px;
    }
    .logo {
      position: absolute;
      top: 40px;
      left: 50%;
      transform: translateX(-50%);
      width: 160px;
      height: auto;
      z-index: 2;
    }
    body.final-active .logo { filter: drop-shadow(0 0 12px rgba(96,215,255,0.6)); }
    .page {
      display: none;
      width: min(90%, 820px);
      background: var(--panel-bg);
      border: 1px solid var(--panel-border);
      border-radius: 32px;
      padding: 56px 48px;
      text-align: center;
      backdrop-filter: blur(28px);
      box-shadow: 0 24px 60px rgba(3, 9, 25, 0.55);
      opacity: 0;
      transition: opacity .35s ease;
      max-height: calc(100vh - 140px);
      overflow: hidden;
      margin: 0 auto;
    }
    .page.active {
      display: flex;
      flex-direction: column;
      align-items: center;
      opacity: 1;
    }
    .page.compact {
      padding: 44px 42px;
    }
    .page.compact h1 {
      font-size: 2.1rem;
    }
    .page.compact .form-group {
      margin-top: 18px;
    }
    .page.compact .staff-grid,
    .page.compact .option-list,
    .page.compact .rating-options,
    .page.compact .recommend-options,
    .page.compact .checkbox-grid,
    .page.compact .card-grid {
      margin-top: 24px;
      gap: 16px;
    }
    .page.compact .checkbox-grid {
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }
    .page.compact .checkbox-item {
      padding: 12px 14px;
    }
    .page.compact .staff-card,
    .page.compact .option-item,
    .page.compact .rating-option,
    .page.compact .recommend-option {
      padding: 20px 16px;
    }
    .page.compact .staff-card img {
      width: 72px;
      height: 72px;
      margin-bottom: 12px;
    }
    h1 {
      margin-top: 0;
      font-size: 2.4rem;
      font-weight: 700;
      line-height: 1.2;
      color: var(--text-light);
      text-shadow: 0 4px 30px rgba(0,0,0,0.35);
    }
    p { color: var(--text-muted); font-size: 1.05rem; }
    .text-optional { color: var(--text-muted); opacity: 0.85; font-size: 0.95rem; }
    #page-idle {
      position: fixed;
      inset: 0;
      display: none;
      background: linear-gradient(135deg, rgba(5, 19, 59, 0.9) 0%, rgba(3, 9, 28, 0.9) 100%);
      border-radius: 0;
      border: 0;
      box-shadow: none;
      padding: 0;
      width: 100%;
      max-width: none;
      height: 100%;
      max-height: none;
    }
    #page-idle.active {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 32px;
    }
    #page-idle .idle-content {
      max-width: 480px;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #page-idle .logo {
      position: static;
      transform: none;
      width: 220px;
      margin: 0 auto 16px;
      filter: drop-shadow(0 0 18px rgba(96,215,255,0.75));
    }
    .idle-title {
      font-size: 3.1rem;
      margin-bottom: 16px;
      text-shadow: 0 0 22px rgba(63,183,255,0.6);
      animation: pulse 3s infinite;
    }
    .idle-subtitle {
      font-size: 1.3rem;
      margin-bottom: 24px;
      color: rgba(224, 235, 255, 0.85);
      animation: fadein 4s ease-in-out infinite;
    }
    @keyframes pulse { 0%,100% { transform: scale(1); opacity: 1 } 50% { transform: scale(1.04); opacity: .92 } }
    @keyframes fadein { 0%,100% { opacity: 1 } 50% { opacity: .6 } }
    .start-btn,
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 18px 64px;
      font-size: 1.25rem;
      font-weight: 700;
      border: none;
      border-radius: 999px;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-strong) 100%);
      color: #071a3d;
      cursor: pointer;
      box-shadow: 0 14px 45px rgba(63, 183, 255, 0.55);
      transition: transform .2s ease, box-shadow .2s ease, filter .2s ease;
    }
    .start-btn { font-size: 1.5rem; padding: 20px 72px; }
    .btn { padding: 16px 44px; font-size: 1.15rem; }
    .start-btn:hover,
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 24px 60px rgba(63, 183, 255, 0.65);
    }
    .start-btn:active,
    .btn:active { transform: translateY(1px); box-shadow: 0 12px 36px rgba(63,183,255,0.45); }
    .btn:disabled {
      cursor: not-allowed;
      opacity: 0.5;
      box-shadow: none;
      transform: none;
    }
    .btn + .back-btn { margin-top: 20px; }
    .back-btn {
      margin-top: 28px;
      padding: 14px 30px;
      font-size: 1.05rem;
      border-radius: 999px;
      border: 1px solid rgba(96, 215, 255, 0.4);
      background: rgba(6, 22, 58, 0.6);
      color: var(--text-light);
      cursor: pointer;
      transition: background .2s ease, border-color .2s ease, transform .2s ease;
    }
    .back-btn:hover {
      background: rgba(9, 30, 74, 0.8);
      border-color: rgba(96, 215, 255, 0.7);
      transform: translateY(-1px);
    }
    .back-btn:active { transform: translateY(0); }
    #phoneInput,
    #commentInput,
    select {
      width: 100%;
      padding: 18px 22px;
      font-size: 1.15rem;
      border-radius: 20px;
      border: 1px solid var(--panel-border);
      background: var(--card-bg);
      color: var(--text-light);
      box-shadow: inset 0 1px 18px rgba(2, 9, 30, 0.75);
    }
    #phoneInput::placeholder,
    #commentInput::placeholder { color: var(--text-muted); }
    select option { color: #071a3d; }
    .form-group {
      width: 100%;
      text-align: left;
      margin-top: 24px;
    }
    .form-group label {
      display: block;
      margin-bottom: 12px;
      font-weight: 600;
      color: var(--text-light);
    }
    .form-grid {
      display: grid;
      width: 100%;
      gap: 20px;
      margin-top: 12px;
    }
    .form-grid .form-group {
      margin-top: 0;
    }
    .form-grid.two-col {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
    .form-grid.two-col .form-group.full-width {
      grid-column: 1 / -1;
    }
    .demographics-grid {
      --demographics-gap: 32px;
      position: relative;
      column-gap: var(--demographics-gap);
      row-gap: 16px;
      padding: 4px 0;
    }
    .demographics-grid::after {
      content: "";
      position: absolute;
      top: 0;
      bottom: 0;
      left: calc(50% - (var(--demographics-gap) / 2));
      width: 1px;
      background: rgba(96, 215, 255, 0.2);
    }
    #page-gender .form-group,
    #page-age .form-group,
    #page-address .form-group {
      margin-top: 16px;
    }
    #page-gender .form-group label,
    #page-age .form-group label,
    #page-address .form-group label {
      margin-bottom: 8px;
    }
    #page-gender .card-grid,
    #page-age .card-grid {
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      margin-top: 12px;
      gap: 12px;
    }
    #page-gender .card-item,
    #page-age .card-item {
      min-height: 60px;
      padding: 18px 14px;
      font-size: 1.05rem;
    }
    .district-map {
      width: 100%;
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 280px);
      gap: 24px;
      align-items: center;
      margin-top: 12px;
    }
    .district-map svg {
      width: 100%;
      height: auto;
      max-height: 380px;
      border-radius: 24px;
      background: rgba(3, 14, 42, 0.7);
      border: 1px solid rgba(96, 215, 255, 0.2);
      box-shadow: inset 0 0 24px rgba(2, 10, 30, 0.6);
    }
    .district-shape polygon {
      stroke: rgba(255, 255, 255, 0.75);
      stroke-width: 1.5;
      cursor: pointer;
      transition: transform 0.2s ease, filter 0.2s ease;
    }
    .district-shape:hover polygon {
      filter: brightness(1.1);
      transform: translateY(-2px);
    }
    .district-shape.selected polygon {
      stroke-width: 2.5;
      filter: brightness(1.2);
    }
    .district-label {
      font-size: 12px;
      fill: #ffffff;
      font-weight: 600;
      pointer-events: none;
      text-shadow: 0 1px 6px rgba(0, 0, 0, 0.45);
    }
    .district-legend {
      display: grid;
      gap: 10px;
    }
    .district-btn {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid var(--panel-border);
      background: var(--card-bg);
      color: var(--text-light);
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s ease, border-color 0.2s ease;
    }
    .district-btn span {
      width: 14px;
      height: 14px;
      border-radius: 6px;
      display: inline-block;
    }
    .district-btn.selected {
      border-color: rgba(96, 215, 255, 0.8);
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(63, 183, 255, 0.25);
    }
    .district-selected {
      margin-top: 18px;
      font-weight: 600;
      color: var(--accent-strong);
    }
    .helper-text {
      margin-top: 8px;
      font-size: 0.95rem;
      color: var(--text-muted);
    }
    .checkbox-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      border-radius: 18px;
      border: 1px solid var(--panel-border);
      background: var(--card-bg);
      box-shadow: inset 0 1px 18px rgba(2, 9, 30, 0.75);
      cursor: pointer;
    }
    .checkbox-item input {
      width: 20px;
      height: 20px;
      accent-color: var(--accent);
    }
    .staff-grid,
    .option-list,
    .rating-options,
    .recommend-options,
    .card-grid {
      display: grid;
      width: 100%;
      margin-top: 36px;
      gap: 20px;
    }
    .staff-grid { grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); }
    .option-list { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
    .option-list.contact { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); }
    .rating-options { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }
    .recommend-options { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }
    .card-grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
    .card-grid.choice-grid {
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      margin-top: 16px;
    }
    .staff-card,
    .option-item,
    .rating-option,
    .recommend-option,
    .card-item {
      background: var(--card-bg);
      border: 1px solid var(--panel-border);
      border-radius: 22px;
      padding: 26px 20px;
      text-align: center;
      color: var(--text-light);
      cursor: pointer;
      transition: transform .15s ease, box-shadow .2s ease, border-color .2s ease, background .2s ease;
      box-shadow: 0 18px 40px rgba(2, 6, 22, 0.45);
    }
    .staff-card:hover,
    .option-item:hover,
    .rating-option:hover,
    .recommend-option:hover,
    .card-item:hover {
      transform: translateY(-4px);
      border-color: rgba(96, 215, 255, 0.7);
      box-shadow: 0 26px 55px rgba(2, 6, 22, 0.55);
    }
    .staff-card.selected,
    .option-item.selected,
    .rating-option.selected,
    .recommend-option.selected,
    .card-item.selected {
      background: var(--card-selected);
      border-color: var(--accent);
      box-shadow: 0 28px 60px rgba(63, 183, 255, 0.45);
      transform: translateY(-4px);
    }
    .card-item {
      font-weight: 600;
      font-size: 1.05rem;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 70px;
    }
    .card-item.choice-item {
      padding: 18px 16px;
      min-height: 58px;
    }
    .card-item .card-subtitle {
      display: block;
      font-size: 0.9rem;
      color: var(--text-muted);
      font-weight: 500;
      margin-top: 6px;
    }
    .staff-card img {
      width: 84px;
      height: 84px;
      border-radius: 18px;
      object-fit: cover;
      margin-bottom: 16px;
      background: rgba(63, 183, 255, 0.15);
      border: 1px solid rgba(96, 215, 255, 0.35);
    }
    .staff-card .name { font-weight: 600; }
    .staff-card .branch {
      margin-top: 4px;
      font-size: 0.85rem;
      color: var(--text-muted);
    }
    .rating-option img { width: 68px; height: 68px; margin-bottom: 16px; }
    .rating-option .label,
    .recommend-option .label {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-light);
    }
    .rating-option .emoji {
      font-size: 2.2rem;
      display: block;
      margin-bottom: 12px;
    }
    .recommend-option .emoji {
      font-size: 2.2rem;
      display: block;
      margin-bottom: 12px;
    }
    .recommend-note { margin-top: 16px; font-size: .95rem; color: var(--text-muted); }
    .field-error { margin-top: 12px; color: #ff9fa3; font-size: .95rem; min-height: 1.2em; }
    .progress {
      position: fixed;
      bottom: 40px;
      right: 48px;
      display: none;
      gap: 12px;
      z-index: 2;
    }
    .progress .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.25);
      box-shadow: 0 0 12px rgba(63, 183, 255, 0.4);
    }
    .progress .dot.active {
      background: var(--accent);
      box-shadow: 0 0 16px rgba(96, 215, 255, 0.8);
    }
    .final-page {
      position: fixed;
      inset: 0;
      border-radius: 0;
      border: 0;
      background: linear-gradient(135deg, rgba(5, 19, 59, 0.92) 0%, rgba(6, 22, 72, 0.92) 100%);
      box-shadow: none;
    }
    .final-page h1 { font-size: 3.2rem; }
    .final-page p { margin-top: 32px; }
    .progress-container { width: min(80%, 420px); margin-top: 48px; }
    .progress-track {
      background: rgba(255,255,255,0.15);
      border-radius: 8px;
      height: 12px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-strong) 100%);
      border-radius: 8px;
      transition: width 4s linear;
    }
    #bgAnimation {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      opacity: 0.35;
      background: transparent;
    }
    @media (max-width: 1024px) {
      .page { width: calc(100% - 32px); padding: 44px 28px; }
      .page.compact { padding: 40px 24px; }
      .staff-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
      .card-grid { grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); }
      .card-item { font-size: 1rem; min-height: 64px; }
    }
    @media (max-width: 768px) {
      .page { width: calc(100% - 24px); padding: 40px 20px; }
      .page.compact { padding: 36px 20px; }
      .start-btn,
      .btn,
      .back-btn { width: 100%; }
      .progress { right: 24px; bottom: 28px; }
      .logo { top: 24px; width: 140px; }
      .form-grid.two-col { grid-template-columns: 1fr; }
      .demographics-grid::after { display: none; }
    }
    @media (max-height: 720px) {
      .page { padding: 36px 24px; max-height: calc(100vh - 96px); }
      #page-idle { padding: 32px 20px; }
    }
    @media (max-height: 820px) {
      #page-gender,
      #page-age,
      #page-address {
        padding: 36px 36px;
      }
      #page-gender h1,
      #page-age h1,
      #page-address h1 {
        font-size: 2rem;
      }
      #page-gender .form-group,
      #page-age .form-group,
      #page-address .form-group {
        margin-top: 12px;
      }
      #page-gender .card-grid,
      #page-age .card-grid {
        margin-top: 10px;
        gap: 10px;
      }
      #page-gender .btn,
      #page-age .btn,
      #page-address .btn {
        margin-top: 8px;
      }
      #page-gender .back-btn,
      #page-age .back-btn,
      #page-address .back-btn {
        margin-top: 16px;
      }
      .district-map {
        grid-template-columns: 1fr;
      }
    }
    @media (max-height: 640px) {
      .page { max-height: calc(100vh - 64px); overflow-y: auto; }
      .page.compact h1 { font-size: 1.9rem; }
      .staff-card,
      .option-item,
      .rating-option,
      .recommend-option,
      .card-item { padding: 16px 14px; }
      .card-item { min-height: 56px; }
    }
    @media (max-width: 480px) {
      h1 { font-size: 1.9rem; }
      .idle-title { font-size: 2.4rem; }
      .idle-subtitle { font-size: 1.1rem; }
    }
  </style>
</head>
<body>
    <canvas id="bgAnimation"></canvas>
    <div class="wrapper" id="wrapper">
        <!-- Idle -->
        <div class="page" id="page-idle">
            <img src="assets/liberty.png" alt="Liberty" class="logo" />
            <div class="idle-content">
                <h1 class="idle-title">Please give us feedback</h1>
                <p class="idle-subtitle">Tell us about your customer experience</p>
                <button class="start-btn" id="btnStart">Press to Start</button>
            </div>
        </div>

        <!-- Logo -->
        <!-- Phone -->
        <div class="page" id="page-phone">
            <h1>Please enter your phone number</h1>
            <input type="tel" id="phoneInput" placeholder="Phone number" autocomplete="tel" inputmode="numeric" maxlength="15" />
            <div class="field-error" id="phoneError" role="alert" aria-live="polite"></div>
            <button class="btn" id="btnProceed" disabled>Proceed</button>
        </div>
        <!-- Staff -->
        <div class="page compact" id="page-staff">
            <h1>I was assisted by...</h1>
            <div class="form-group">
                <div class="staff-grid" id="staffGrid"></div>
            </div>
            <button class="btn" id="btnStaffContinue" disabled>Continue</button>
            <button class="back-btn" id="backFromStaff">Back</button>
        </div>
        <!-- Gender -->
        <div class="page compact" id="page-gender">
            <h1>Tell us about yourself</h1>
            <div class="form-group">
                <label>Gender</label>
                <div class="card-grid choice-grid" id="genderOptions" role="list"></div>
            </div>
            <button class="btn" id="btnGenderContinue" disabled>Continue</button>
            <button class="back-btn" id="backFromGender">Back</button>
        </div>
        <!-- Age range -->
        <div class="page compact" id="page-age">
            <h1>Select your age range</h1>
            <div class="form-group">
                <label>Age range</label>
                <div class="card-grid choice-grid" id="ageRangeOptions" role="list"></div>
            </div>
            <button class="btn" id="btnAgeContinue" disabled>Continue</button>
            <button class="back-btn" id="backFromAge">Back</button>
        </div>
        <!-- Residential Address -->
        <div class="page compact" id="page-address">
            <h1>Residential Address (City)</h1>
            <p class="helper-text">Tap your district on the map or choose from the list.</p>
            <div class="district-map" id="districtMap">
                <svg viewBox="0 0 420 540" role="img" aria-label="Map of Lesotho districts">
                    <g class="district-shape" data-district="Butha-Buthe">
                        <polygon fill="#56b3ff" points="40,20 160,20 170,90 120,130 50,100" />
                        <text class="district-label" x="80" y="80">Butha-Buthe</text>
                    </g>
                    <g class="district-shape" data-district="Mokhotlong">
                        <polygon fill="#7ad98c" points="220,20 360,40 380,120 300,150 220,110" />
                        <text class="district-label" x="255" y="85">Mokhotlong</text>
                    </g>
                    <g class="district-shape" data-district="Leribe">
                        <polygon fill="#ffd86b" points="40,120 140,140 170,210 120,250 50,220" />
                        <text class="district-label" x="75" y="190">Leribe</text>
                    </g>
                    <g class="district-shape" data-district="Berea">
                        <polygon fill="#f08ad5" points="160,130 240,140 250,220 170,230 150,200" />
                        <text class="district-label" x="172" y="190">Berea</text>
                    </g>
                    <g class="district-shape" data-district="Thaba-Tseka">
                        <polygon fill="#ffa874" points="250,150 360,170 370,260 300,300 240,240" />
                        <text class="district-label" x="260" y="225">Thaba-Tseka</text>
                    </g>
                    <g class="district-shape" data-district="Maseru">
                        <polygon fill="#8fd1ff" points="80,240 150,250 170,320 120,360 60,320" />
                        <text class="district-label" x="85" y="310">Maseru</text>
                    </g>
                    <g class="district-shape" data-district="Mafeteng">
                        <polygon fill="#ffb8c6" points="40,330 120,370 140,430 70,460 30,400" />
                        <text class="district-label" x="50" y="405">Mafeteng</text>
                    </g>
                    <g class="district-shape" data-district="Mohale's Hoek">
                        <polygon fill="#b8ffa8" points="150,330 230,340 240,410 180,460 130,420" />
                        <text class="district-label" x="155" y="405">Mohale's Hoek</text>
                    </g>
                    <g class="district-shape" data-district="Qacha's Nek">
                        <polygon fill="#8f9bff" points="240,330 340,320 380,380 340,460 240,440 230,380" />
                        <text class="district-label" x="262" y="395">Qacha's Nek</text>
                    </g>
                    <g class="district-shape" data-district="Quthing">
                        <polygon fill="#f8c47c" points="70,460 150,470 140,520 60,520 40,490" />
                        <text class="district-label" x="75" y="505">Quthing</text>
                    </g>
                </svg>
                <div class="district-legend" id="districtList"></div>
            </div>
            <div class="district-selected" id="districtSelected">No district selected</div>
            <button class="btn" id="btnAddressContinue" disabled>Continue</button>
            <button class="back-btn" id="backFromAddress">Back</button>
        </div>
        <!-- Service -->
        <div class="page compact" id="page-service">
            <h1>Which Liberty service were you assisted with today?</h1>
            <div class="form-group">
                <label>Service</label>
                <div class="card-grid" id="serviceOptions" role="list"></div>
            </div>
            <div class="form-group">
                <label>Policies assisted with</label>
                <div class="card-grid" id="policyOptions" role="list"></div>
                <p class="helper-text">Select all that apply.</p>
            </div>
            <button class="btn" id="btnProceedService" disabled>Continue</button>
            <button class="back-btn" id="backFromService">Back</button>
        </div>
        <!-- Satisfaction -->
        <div class="page compact" id="page-satisfaction">
            <h1>How satisfied are you with your recent interaction?</h1>
            <div class="rating-options" id="optsSatisfaction"></div>
            <button class="back-btn" id="backFromSatisfaction">Back</button>
        </div>
        <!-- Time -->
        <div class="page compact" id="page-time">
            <h1>Was your query handled within a reasonable time?</h1>
            <div class="rating-options" id="optsTime"></div>
            <button class="back-btn" id="backFromTime">Back</button>
        </div>
        <!-- Recommend -->
        <div class="page compact" id="page-recommend">
            <h1>How likely are you to recommend Liberty to a friend or family member?</h1>
            <div class="recommend-options" id="optsRecommend"></div>
            <p class="recommend-note">(1 = Not at all likely &rarr; 5 = Extremely likely)</p>
            <button class="back-btn" id="backFromRecommend">Back</button>
        </div>
        <!-- Contact -->
        <div class="page compact" id="page-contact">
            <h1>Would you like someone to contact you about your experience?</h1>
            <div class="option-list contact" id="optsContact"></div>
            <button class="back-btn" id="backFromContact">Back</button>
        </div>
        <!-- Comment -->
        <div class="page" id="page-comment">
            <h1>Please tell us briefly what we could do better.</h1>
            <p class="text-optional">Optional</p>
            <textarea id="commentInput" placeholder="Type your feedback here..." rows="5"></textarea>
            <button class="btn" id="btnSubmitComment">Submit Feedback</button>
            <button class="back-btn" id="backFromComment">Back</button>
        </div>
        <!-- Final -->
        <div class="page final-page" id="page-final">
            <h1>Thank you for your feedback</h1>
            <p>Your input helps us improve our service.</p>
            <div class="progress-container">
                <div class="progress-track"><div class="progress-fill" id="finalProgress"></div></div>
            </div>
        </div>
        <!-- Step dots -->
        <div class="progress" id="progress">
            <div class="dot" data-step="0"></div>
            <div class="dot" data-step="1"></div>
            <div class="dot" data-step="2"></div>
            <div class="dot" data-step="3"></div>
            <div class="dot" data-step="4"></div>
            <div class="dot" data-step="5"></div>
            <div class="dot" data-step="6"></div>
            <div class="dot" data-step="7"></div>
            <div class="dot" data-step="8"></div>
            <div class="dot" data-step="9"></div>
        </div>
    </div>

        <script src="app-base.js"></script>
<script>
        (function () {
            const ratingColours = ['#e74c3c', '#e67e22', '#f1c40f', '#2ecc71', '#27ae60'];
            const satisfactionOptions = [
                { value: 1, emoji: '😡', label: 'Very Poor' },
                { value: 2, emoji: '😞', label: 'Poor' },
                { value: 3, emoji: '😐', label: 'Okay' },
                { value: 4, emoji: '🙂', label: 'Good' },
                { value: 5, emoji: '😁', label: 'Excellent' }
            ];
            const timeOptions = [
                { value: 1, emoji: '😤', label: 'Not at all' },
                { value: 2, emoji: '😕', label: 'No' },
                { value: 3, emoji: '😐', label: 'Neutral' },
                { value: 4, emoji: '🙂', label: 'Yes, mostly' },
                { value: 5, emoji: '😄', label: 'Absolutely' }
            ];
            const recommendOptions = [
                { value: 1, emoji: '😡', label: 'Not at all likely' },
                { value: 2, emoji: '😞', label: 'Slightly likely' },
                { value: 3, emoji: '😐', label: 'Neutral' },
                { value: 4, emoji: '😃', label: 'Very likely' },
                { value: 5, emoji: '😊', label: 'Extremely likely' }
            ];
            const services = [
                'Policy enquiry/ Query',
                'Complaint',
                'Claim',
                'New policy application',
                'Payment',
                'Amendments/ Policy Changes',
                'Other'
            ];
            const genders = ['Female', 'Male'];
            const ageRanges = ['18-35', '36-45', 'Over 45'];
            const policyOptions = ['Retail Funeral Policy', 'Life Cover', 'Education Lagacy Plan'];
            const districts = [
                { name: 'Butha-Buthe', color: '#56b3ff' },
                { name: 'Mokhotlong', color: '#7ad98c' },
                { name: 'Leribe', color: '#ffd86b' },
                { name: 'Berea', color: '#f08ad5' },
                { name: 'Thaba-Tseka', color: '#ffa874' },
                { name: 'Maseru', color: '#8fd1ff' },
                { name: 'Mafeteng', color: '#ffb8c6' },
                { name: "Mohale's Hoek", color: '#b8ffa8' },
                { name: "Qacha's Nek", color: '#8f9bff' },
                { name: 'Quthing', color: '#f8c47c' }
            ];
            const contactChoices = [
                { value: 'yes', label: 'Yes' },
                { value: 'no', label: 'No' }
            ];

            const pages = ['page-idle', 'page-phone', 'page-staff', 'page-gender', 'page-age', 'page-address', 'page-service', 'page-satisfaction', 'page-time', 'page-recommend', 'page-contact', 'page-comment', 'page-final'];
            const state = {
                phone: '',
                staff: null,
                staffName: null,
                staffBranchId: null,
                staffBranchName: null,
                gender: null,
                ageRange: null,
                city: null,
                service: null,
                policies: [],
                satisfactionRating: null,
                timeRating: null,
                recommend: null,
                contactPreference: null,
                comment: '',
                startedAt: null,
                duration: 0
            };
            let currentIndex = 0;
            const byId = id => document.getElementById(id);

            function showPage(idx) {
                currentIndex = idx;
                pages.forEach((pid, i) => {
                    const p = byId(pid);
                    p.classList.toggle('active', i === idx);
                    p.style.removeProperty('display');
                });
                const prog = byId('progress');
                if (idx >= 2 && idx <= 11) {
                    prog.style.display = 'flex';
                    prog.querySelectorAll('.dot').forEach((d, i) => d.classList.toggle('active', i === (idx - 2)));
                } else {
                    prog.style.display = 'none';
                }
                document.body.classList.toggle('final-active', pages[idx] === 'page-final');
                if (pages[idx] === 'page-phone') setTimeout(() => byId('phoneInput').focus(), 50);
            }

            async function fetchRosterFromServer() {
                const token = localStorage.getItem('authToken');
                if (!token) return [];
                try {
                    const r = await fetch('/api/staff?active=true', { headers: { 'Authorization': 'Bearer ' + token } });
                    if (r.ok) {
                        const staff = await r.json();
                        localStorage.setItem('kiosk_staff', JSON.stringify(staff));
                        return staff.map(s => ({ id: s.id, name: s.name, photo: s.photoUrl || null, branchId: s.branchId, branchName: s.branchName }));
                    }
                } catch (e) { console.warn('Roster fetch failed', e); }
                return [];
            }

            const placeholderAvatar = `data:image/svg+xml;utf8,${encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 120"><rect width="120" height="120" rx="28" fill="#0d2148"/><circle cx="60" cy="46" r="22" fill="#8dc8ff"/><path d="M20 106c8-22 32-34 40-34s32 12 40 34" fill="#5aa7f5"/></svg>')}`;

            function renderStaff(roster) {
                const host = byId('staffGrid');
                host.innerHTML = '';
                if (!roster || roster.length === 0) {
                    const empty = document.createElement('div');
                    empty.className = 'staff-card';
                    empty.textContent = 'No staff configured for this branch';
                    empty.style.cursor = 'default';
                    host.appendChild(empty);
                    return;
                }
                roster.forEach(m => {
                    const card = document.createElement('div');
                    card.className = 'staff-card';
                    card.dataset.id = m.id;
                    card.dataset.branchId = m.branchId ?? '';
                    card.dataset.branchName = m.branchName ?? '';
                    const photo = m.photo || placeholderAvatar;
                    const branchLabel = m.branchName ? `<div class="branch">${m.branchName}</div>` : '';
                    card.innerHTML = `<img src="${photo}" alt="${m.name || 'Staff member'}"><div class="name">${m.name}</div>${branchLabel}`;
                    const img = card.querySelector('img');
                    if (img) {
                        img.addEventListener('error', () => {
                            if (img.src !== placeholderAvatar) img.src = placeholderAvatar;
                        }, { once: true });
                    }
                    card.addEventListener('click', () => {
                        host.querySelectorAll('.staff-card').forEach(el => el.classList.remove('selected'));
                        card.classList.add('selected');
                        state.staff = m.id;
                        state.staffName = m.name;
                        state.staffBranchId = m.branchId ?? null;
                        state.staffBranchName = m.branchName ?? null;
                        updateStaffSelectionState();
                    });
                    host.appendChild(card);
                });
            }

            function renderServiceOptions() {
                const host = byId('serviceOptions');
                host.innerHTML = '';
                services.forEach(service => {
                    const card = document.createElement('button');
                    card.type = 'button';
                    card.className = 'card-item';
                    card.dataset.value = service;
                    card.textContent = service;
                    card.addEventListener('click', () => {
                        host.querySelectorAll('.card-item').forEach(el => el.classList.remove('selected'));
                        card.classList.add('selected');
                        state.service = service;
                        const btnProceedService = byId('btnProceedService');
                        if (btnProceedService) btnProceedService.disabled = !state.service;
                    });
                    host.appendChild(card);
                });
            }

            function renderPolicyOptions() {
                const host = byId('policyOptions');
                host.innerHTML = '';
                policyOptions.forEach(policy => {
                    const card = document.createElement('button');
                    card.type = 'button';
                    card.className = 'card-item';
                    card.dataset.value = policy;
                    card.textContent = policy;
                    card.addEventListener('click', () => {
                        card.classList.toggle('selected');
                        const selections = Array.from(host.querySelectorAll('.card-item.selected')).map(el => el.dataset.value);
                        state.policies = selections;
                    });
                    host.appendChild(card);
                });
            }

            function renderChoiceCards(hostId, options, onSelect) {
                const host = byId(hostId);
                if (!host) return;
                host.innerHTML = '';
                options.forEach(option => {
                    const card = document.createElement('button');
                    card.type = 'button';
                    card.className = 'card-item choice-item';
                    card.dataset.value = option;
                    card.textContent = option;
                    card.addEventListener('click', () => {
                        host.querySelectorAll('.card-item').forEach(el => el.classList.remove('selected'));
                        card.classList.add('selected');
                        onSelect(option);
                    });
                    host.appendChild(card);
                });
            }

            function renderRecommendOptions() {
                const host = byId('optsRecommend');
                host.innerHTML = '';
                recommendOptions.forEach((opt, idx) => {
                    const el = document.createElement('div');
                    el.className = 'recommend-option';
                    el.dataset.value = opt.value;
                    el.innerHTML = `<span class="emoji">${opt.emoji}</span><span class="label">${opt.label}</span>`;
                    el.style.backgroundColor = ratingColours[idx];
                    el.style.borderColor = ratingColours[idx];
                    el.addEventListener('click', () => {
                        state.recommend = opt.value;
                        host.querySelectorAll('.recommend-option').forEach(o => o.classList.remove('selected'));
                        el.classList.add('selected');
                        setTimeout(() => showPage(10), 150);
                    });
                    host.appendChild(el);
                });
            }

            function renderRatingOptions(hostId, options, onSelect) {
                const host = byId(hostId);
                host.innerHTML = '';
                options.forEach((opt, idx) => {
                    const el = document.createElement('div');
                    el.className = 'rating-option';
                    el.dataset.value = opt.value;
                    const emoji = opt.emoji ? `<span class="emoji">${opt.emoji}</span>` : '';
                    el.innerHTML = `${emoji}<span class="label">${opt.label}</span>`;
                    el.style.backgroundColor = ratingColours[idx];
                    el.style.borderColor = ratingColours[idx];
                    el.addEventListener('click', () => {
                        onSelect(opt.value);
                        host.querySelectorAll('.rating-option').forEach(o => o.classList.remove('selected'));
                        el.classList.add('selected');
                    });
                    host.appendChild(el);
                });
            }

            function renderContactOptions() {
                const host = byId('optsContact');
                host.innerHTML = '';
                contactChoices.forEach(choice => {
                    const el = document.createElement('div');
                    el.className = 'option-item';
                    el.textContent = choice.label;
                    el.addEventListener('click', () => {
                        state.contactPreference = choice.value;
                        host.querySelectorAll('.option-item').forEach(o => o.classList.remove('selected'));
                        el.classList.add('selected');
                        setTimeout(() => showPage(11), 150);
                    });
                    host.appendChild(el);
                });
            }

            function selectDistrict(name) {
                state.city = name;
                const districtSelected = byId('districtSelected');
                if (districtSelected) {
                    districtSelected.textContent = name ? `Selected district: ${name}` : 'No district selected';
                }
                const mapHost = byId('districtMap');
                if (mapHost) {
                    mapHost.querySelectorAll('.district-shape').forEach(el => {
                        el.classList.toggle('selected', el.dataset.district === name);
                    });
                }
                const districtList = byId('districtList');
                if (districtList) {
                    districtList.querySelectorAll('.district-btn').forEach(el => {
                        el.classList.toggle('selected', el.dataset.district === name);
                    });
                }
                const btnAddressContinue = byId('btnAddressContinue');
                if (btnAddressContinue) btnAddressContinue.disabled = !state.city;
            }

            function renderDistrictMap() {
                const mapHost = byId('districtMap');
                if (mapHost) {
                    mapHost.querySelectorAll('.district-shape').forEach(el => {
                        el.addEventListener('click', () => {
                            const district = el.dataset.district;
                            if (district) selectDistrict(district);
                        });
                    });
                }
                const districtList = byId('districtList');
                if (districtList) {
                    districtList.innerHTML = '';
                    districts.forEach(district => {
                        const button = document.createElement('button');
                        button.type = 'button';
                        button.className = 'district-btn';
                        button.dataset.district = district.name;
                        button.innerHTML = `<span style="background:${district.color}"></span>${district.name}`;
                        button.addEventListener('click', () => selectDistrict(district.name));
                        districtList.appendChild(button);
                    });
                }
                selectDistrict(state.city);
            }

            function persistResponse() {
                (async () => {
                    try {
                        await fetch('/api/feedback', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                phone: state.phone,
                                staffId: state.staff,
                                staffName: state.staffName,
                                serviceType: state.service,
                                gender: state.gender,
                                ageRange: state.ageRange,
                                city: state.city,
                                policies: state.policies,
                                timeRating: state.timeRating,
                                overallRating: state.satisfactionRating,
                                respectRating: state.recommend,
                                recommendRating: state.recommend,
                                contactPreference: state.contactPreference,
                                comment: state.comment,
                                startedUtc: state.startedAt ? new Date(state.startedAt).toISOString() : undefined,
                                durationSeconds: state.duration ?? 0,
                                branchId: state.staffBranchId,
                                branchName: state.staffBranchName
                            })
                        });
                    } catch (e) {
                        console.warn('Feedback submit failed', e);
                    }
                })();
            }

            function resetState() {
                state.phone = '';
                state.staff = null;
                state.staffName = null;
                state.staffBranchId = null;
                state.staffBranchName = null;
                state.gender = null;
                state.ageRange = null;
                state.city = null;
                state.service = null;
                state.policies = [];
                state.satisfactionRating = null;
                state.timeRating = null;
                state.recommend = null;
                state.contactPreference = null;
                state.comment = '';
                state.duration = 0;
                state.startedAt = null;
                const phoneInput = byId('phoneInput');
                phoneInput.value = '';
                const phoneError = byId('phoneError');
                if (phoneError) phoneError.textContent = '';
                byId('btnProceed').disabled = true;
                ['optsSatisfaction', 'optsTime', 'optsRecommend', 'optsContact'].forEach(id => {
                    const host = byId(id);
                    if (host) host.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
                });
                const staffGrid = byId('staffGrid');
                if (staffGrid) staffGrid.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
                const genderOptions = byId('genderOptions');
                if (genderOptions) genderOptions.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
                const ageRangeOptions = byId('ageRangeOptions');
                if (ageRangeOptions) ageRangeOptions.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
                const districtList = byId('districtList');
                if (districtList) districtList.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
                const districtMap = byId('districtMap');
                if (districtMap) districtMap.querySelectorAll('.district-shape').forEach(el => el.classList.remove('selected'));
                const districtSelected = byId('districtSelected');
                if (districtSelected) districtSelected.textContent = 'No district selected';
                const serviceHost = byId('serviceOptions');
                if (serviceHost) serviceHost.querySelectorAll('.card-item.selected').forEach(el => el.classList.remove('selected'));
                const policyHost = byId('policyOptions');
                if (policyHost) policyHost.querySelectorAll('.card-item.selected').forEach(el => el.classList.remove('selected'));
                const btnGenderContinue = byId('btnGenderContinue');
                if (btnGenderContinue) btnGenderContinue.disabled = true;
                const btnAgeContinue = byId('btnAgeContinue');
                if (btnAgeContinue) btnAgeContinue.disabled = true;
                const btnAddressContinue = byId('btnAddressContinue');
                if (btnAddressContinue) btnAddressContinue.disabled = true;
                const btnStaffContinue = byId('btnStaffContinue');
                if (btnStaffContinue) btnStaffContinue.disabled = true;
                const btnProceedService = byId('btnProceedService');
                if (btnProceedService) btnProceedService.disabled = true;
                const commentInput = byId('commentInput');
                if (commentInput) commentInput.value = '';
            }

            (async () => {
                const roster = await fetchRosterFromServer();
                renderStaff(roster);
                renderServiceOptions();
                renderPolicyOptions();
                renderDistrictMap();
                renderRatingOptions('optsSatisfaction', satisfactionOptions, value => {
                    state.satisfactionRating = value;
                    setTimeout(() => showPage(8), 150);
                });
                renderRatingOptions('optsTime', timeOptions, value => {
                    state.timeRating = value;
                    setTimeout(() => showPage(9), 150);
                });
                renderRecommendOptions();
                renderContactOptions();
                showPage(0);
            })();

            byId('btnStart').addEventListener('click', () => {
                if (currentIndex === 0) {
                    state.startedAt = Date.now();
                    showPage(1);
                }
            });

            const phoneInput = byId('phoneInput');
            const btnProceed = byId('btnProceed');
            const phoneError = byId('phoneError');
            function validatePhone(v) {
                const digits = v.replace(/\D/g, '');
                return digits.length >= 8 && digits.length <= 15 && digits === v;
            }
            function updatePhoneValidation(showMessage) {
                const value = phoneInput.value.trim();
                state.phone = value;
                const isValid = validatePhone(value);
                btnProceed.disabled = !isValid;
                if (!phoneError) return;
                if (!value && !showMessage) {
                    phoneError.textContent = '';
                    return;
                }
                phoneError.textContent = isValid ? '' : 'Please enter a phone number with at least 8 digits.';
            }
            phoneInput.addEventListener('input', () => {
                phoneInput.value = phoneInput.value.replace(/\D/g, '').slice(0, 15);
                updatePhoneValidation(false);
            });
            phoneInput.addEventListener('blur', () => {
                updatePhoneValidation(true);
            });
            phoneInput.addEventListener('keydown', ev => {
                if (ev.key === 'Enter') {
                    ev.preventDefault();
                    if (btnProceed.disabled) {
                        updatePhoneValidation(true);
                        return;
                    }
                    showPage(2);
                }
            });
            btnProceed.addEventListener('click', () => showPage(2));
            const btnStaffContinue = byId('btnStaffContinue');
            function updateStaffSelectionState() {
                if (!btnStaffContinue) return;
                btnStaffContinue.disabled = !state.staff;
            }
            if (btnStaffContinue) {
                btnStaffContinue.addEventListener('click', () => showPage(3));
            }
            const btnGenderContinue = byId('btnGenderContinue');
            function updateGenderSelectionState() {
                if (!btnGenderContinue) return;
                btnGenderContinue.disabled = !state.gender;
            }
            renderChoiceCards('genderOptions', genders, value => {
                state.gender = value || null;
                updateGenderSelectionState();
            });
            if (btnGenderContinue) {
                btnGenderContinue.addEventListener('click', () => showPage(4));
            }
            const btnAgeContinue = byId('btnAgeContinue');
            function updateAgeSelectionState() {
                if (!btnAgeContinue) return;
                btnAgeContinue.disabled = !state.ageRange;
            }
            renderChoiceCards('ageRangeOptions', ageRanges, value => {
                state.ageRange = value || null;
                updateAgeSelectionState();
            });
            if (btnAgeContinue) {
                btnAgeContinue.addEventListener('click', () => showPage(5));
            }
            const btnAddressContinue = byId('btnAddressContinue');
            if (btnAddressContinue) {
                btnAddressContinue.addEventListener('click', () => showPage(6));
            }
            const btnProceedService = byId('btnProceedService');
            if (btnProceedService) {
                btnProceedService.addEventListener('click', () => showPage(7));
            }
            byId('backFromStaff').addEventListener('click', () => showPage(1));
            byId('backFromGender').addEventListener('click', () => showPage(2));
            byId('backFromAge').addEventListener('click', () => showPage(3));
            byId('backFromAddress').addEventListener('click', () => showPage(4));
            byId('backFromService').addEventListener('click', () => showPage(5));
            byId('backFromSatisfaction').addEventListener('click', () => showPage(6));
            byId('backFromTime').addEventListener('click', () => showPage(7));
            byId('backFromRecommend').addEventListener('click', () => showPage(8));
            byId('backFromContact').addEventListener('click', () => showPage(9));
            byId('backFromComment').addEventListener('click', () => showPage(10));
            byId('btnSubmitComment').addEventListener('click', () => {
                const commentInput = byId('commentInput');
                state.comment = commentInput ? commentInput.value.trim() : '';
                showPage(12);
            });

            const observer = new MutationObserver(() => {
                if (pages[currentIndex] === 'page-final') {
                    state.duration = state.startedAt ? Math.round((Date.now() - state.startedAt) / 1000) : 0;
                    persistResponse();
                    const bar = byId('finalProgress');
                    if (bar) {
                        bar.style.width = '0%';
                        setTimeout(() => { bar.style.width = '100%'; }, 50);
                    }
                    setTimeout(() => {
                        resetState();
                        showPage(0);
                    }, 4000);
                }
            });
            observer.observe(byId('page-final'), { attributes: true, attributeFilter: ['class'] });
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register(appBuildUrl('sw.js')).catch(() => { });
            }
        })();

        const canvas = document.getElementById('bgAnimation');
        const ctx = canvas.getContext('2d');
        let w, h;
        function resize() {
            w = canvas.width = window.innerWidth;
            h = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        let particles = [];
        for (let i = 0; i < 60; i++) {
            particles.push({
                x: Math.random() * w,
                y: Math.random() * h,
                angle: Math.random() * Math.PI * 2,
                radius: 50 + Math.random() * 150,
                speed: 0.002 + Math.random() * 0.003
            });
        }

        function animate() {
            ctx.clearRect(0, 0, w, h);
            ctx.strokeStyle = "rgba(63,183,255,0.3)";
            ctx.lineWidth = 1.5;
            ctx.beginPath();
            particles.forEach(p => {
                p.angle += p.speed;
                const px = p.x + Math.cos(p.angle) * p.radius;
                const py = p.y + Math.sin(p.angle) * p.radius;
                ctx.lineTo(px, py);
            });
            ctx.stroke();
            requestAnimationFrame(animate);
        }
        animate();

    </script>
</body>
</html>
