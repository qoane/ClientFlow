<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Liberty Feedback Kiosk</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0b1020" />
  <style>
    :root {
      --bg-outer: #020716;
      --bg-inner: #05133b;
      --panel-bg: rgba(5, 19, 59, 0.72);
      --panel-border: rgba(80, 140, 255, 0.35);
      --card-bg: rgba(9, 23, 71, 0.65);
      --card-selected: rgba(63, 183, 255, 0.2);
      --text-light: #f5f7ff;
      --text-muted: rgba(245, 247, 255, 0.7);
      --accent: #3fb7ff;
      --accent-strong: #60d7ff;
    }
    * { box-sizing: border-box; }
    html, body {
      height: 100%;
      margin: 0;
      font-family: "Segoe UI", "Roboto", sans-serif;
    }
    body {
      position: relative;
      background: radial-gradient(circle at 20% 20%, rgba(63,183,255,0.25), transparent 55%), linear-gradient(135deg, var(--bg-inner) 0%, var(--bg-outer) 100%);
      color: var(--text-light);
      overflow: hidden;
    }
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: linear-gradient(120deg, rgba(96, 215, 255, 0.08) 0%, transparent 38%, transparent 62%, rgba(96, 215, 255, 0.04) 100%);
      pointer-events: none;
      z-index: 0;
    }
    .wrapper {
      position: relative;
      z-index: 1;
      height: 100%;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 48px 20px;
      gap: 32px;
    }
    .logo {
      position: absolute;
      top: 40px;
      left: 50%;
      transform: translateX(-50%);
      width: 160px;
      height: auto;
      z-index: 2;
    }
    body.final-active .logo { filter: drop-shadow(0 0 12px rgba(96,215,255,0.6)); }
    .page {
      display: none;
      width: min(90%, 820px);
      background: var(--panel-bg);
      border: 1px solid var(--panel-border);
      border-radius: 32px;
      padding: 56px 48px;
      text-align: center;
      backdrop-filter: blur(28px);
      box-shadow: 0 24px 60px rgba(3, 9, 25, 0.55);
      opacity: 0;
      transition: opacity .35s ease;
    }
    .page.active {
      display: flex;
      flex-direction: column;
      align-items: center;
      opacity: 1;
    }
    h1 {
      margin-top: 0;
      font-size: 2.4rem;
      font-weight: 700;
      line-height: 1.2;
      color: var(--text-light);
      text-shadow: 0 4px 30px rgba(0,0,0,0.35);
    }
    p { color: var(--text-muted); font-size: 1.05rem; }
    .text-optional { color: var(--text-muted); opacity: 0.85; font-size: 0.95rem; }
    #page-idle {
      position: fixed;
      inset: 0;
      display: none;
      background: linear-gradient(135deg, rgba(5, 19, 59, 0.9) 0%, rgba(3, 9, 28, 0.9) 100%);
      border-radius: 0;
      border: 0;
      box-shadow: none;
      padding: 0;
    }
    #page-idle.active {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 32px;
    }
    #page-idle .idle-content { max-width: 480px; }
    #page-idle .logo {
      position: static;
      transform: none;
      width: 220px;
      margin-bottom: 16px;
      filter: drop-shadow(0 0 18px rgba(96,215,255,0.75));
    }
    .idle-title {
      font-size: 3.1rem;
      margin-bottom: 16px;
      text-shadow: 0 0 22px rgba(63,183,255,0.6);
      animation: pulse 3s infinite;
    }
    .idle-subtitle {
      font-size: 1.3rem;
      margin-bottom: 24px;
      color: rgba(224, 235, 255, 0.85);
      animation: fadein 4s ease-in-out infinite;
    }
    @keyframes pulse { 0%,100% { transform: scale(1); opacity: 1 } 50% { transform: scale(1.04); opacity: .92 } }
    @keyframes fadein { 0%,100% { opacity: 1 } 50% { opacity: .6 } }
    .start-btn,
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 18px 64px;
      font-size: 1.25rem;
      font-weight: 700;
      border: none;
      border-radius: 999px;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-strong) 100%);
      color: #071a3d;
      cursor: pointer;
      box-shadow: 0 14px 45px rgba(63, 183, 255, 0.55);
      transition: transform .2s ease, box-shadow .2s ease, filter .2s ease;
    }
    .start-btn { font-size: 1.5rem; padding: 20px 72px; }
    .btn { padding: 16px 44px; font-size: 1.15rem; }
    .start-btn:hover,
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 24px 60px rgba(63, 183, 255, 0.65);
    }
    .start-btn:active,
    .btn:active { transform: translateY(1px); box-shadow: 0 12px 36px rgba(63,183,255,0.45); }
    .btn:disabled {
      cursor: not-allowed;
      opacity: 0.5;
      box-shadow: none;
      transform: none;
    }
    .btn + .back-btn { margin-top: 20px; }
    .back-btn {
      margin-top: 28px;
      padding: 14px 30px;
      font-size: 1.05rem;
      border-radius: 999px;
      border: 1px solid rgba(96, 215, 255, 0.4);
      background: rgba(6, 22, 58, 0.6);
      color: var(--text-light);
      cursor: pointer;
      transition: background .2s ease, border-color .2s ease, transform .2s ease;
    }
    .back-btn:hover {
      background: rgba(9, 30, 74, 0.8);
      border-color: rgba(96, 215, 255, 0.7);
      transform: translateY(-1px);
    }
    .back-btn:active { transform: translateY(0); }
    #phoneInput,
    #commentInput,
    select {
      width: 100%;
      padding: 18px 22px;
      font-size: 1.15rem;
      border-radius: 20px;
      border: 1px solid var(--panel-border);
      background: var(--card-bg);
      color: var(--text-light);
      box-shadow: inset 0 1px 18px rgba(2, 9, 30, 0.75);
    }
    #phoneInput::placeholder,
    #commentInput::placeholder { color: var(--text-muted); }
    select option { color: #071a3d; }
    .form-group {
      width: 100%;
      text-align: left;
      margin-top: 24px;
    }
    .form-group label {
      display: block;
      margin-bottom: 12px;
      font-weight: 600;
      color: var(--text-light);
    }
    .helper-text {
      margin-top: 8px;
      font-size: 0.95rem;
      color: var(--text-muted);
    }
    .checkbox-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      border-radius: 18px;
      border: 1px solid var(--panel-border);
      background: var(--card-bg);
      box-shadow: inset 0 1px 18px rgba(2, 9, 30, 0.75);
      cursor: pointer;
    }
    .checkbox-item input {
      width: 20px;
      height: 20px;
      accent-color: var(--accent);
    }
    .staff-grid,
    .option-list,
    .rating-options,
    .recommend-options {
      display: grid;
      width: 100%;
      margin-top: 36px;
      gap: 20px;
    }
    .staff-grid { grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); }
    .option-list { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
    .option-list.contact { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); }
    .rating-options { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }
    .recommend-options { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }
    .staff-card,
    .option-item,
    .rating-option,
    .recommend-option {
      background: var(--card-bg);
      border: 1px solid var(--panel-border);
      border-radius: 22px;
      padding: 26px 20px;
      text-align: center;
      color: var(--text-light);
      cursor: pointer;
      transition: transform .15s ease, box-shadow .2s ease, border-color .2s ease, background .2s ease;
      box-shadow: 0 18px 40px rgba(2, 6, 22, 0.45);
    }
    .staff-card:hover,
    .option-item:hover,
    .rating-option:hover,
    .recommend-option:hover {
      transform: translateY(-4px);
      border-color: rgba(96, 215, 255, 0.7);
      box-shadow: 0 26px 55px rgba(2, 6, 22, 0.55);
    }
    .staff-card.selected,
    .option-item.selected,
    .rating-option.selected,
    .recommend-option.selected {
      background: var(--card-selected);
      border-color: var(--accent);
      box-shadow: 0 28px 60px rgba(63, 183, 255, 0.45);
      transform: translateY(-4px);
    }
    .staff-card img {
      width: 84px;
      height: 84px;
      border-radius: 18px;
      object-fit: cover;
      margin-bottom: 16px;
      background: rgba(63, 183, 255, 0.15);
    }
    .staff-card .name { font-weight: 600; }
    .rating-option img { width: 68px; height: 68px; margin-bottom: 16px; }
    .rating-option .label,
    .recommend-option .label {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-light);
    }
    .recommend-option .emoji {
      font-size: 2.2rem;
      display: block;
      margin-bottom: 12px;
    }
    .recommend-note { margin-top: 16px; font-size: .95rem; color: var(--text-muted); }
    .field-error { margin-top: 12px; color: #ff9fa3; font-size: .95rem; min-height: 1.2em; }
    .progress {
      position: fixed;
      bottom: 40px;
      right: 48px;
      display: none;
      gap: 12px;
      z-index: 2;
    }
    .progress .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.25);
      box-shadow: 0 0 12px rgba(63, 183, 255, 0.4);
    }
    .progress .dot.active {
      background: var(--accent);
      box-shadow: 0 0 16px rgba(96, 215, 255, 0.8);
    }
    .final-page {
      position: fixed;
      inset: 0;
      border-radius: 0;
      border: 0;
      background: linear-gradient(135deg, rgba(5, 19, 59, 0.92) 0%, rgba(6, 22, 72, 0.92) 100%);
      box-shadow: none;
    }
    .final-page h1 { font-size: 3.2rem; }
    .final-page p { margin-top: 32px; }
    .progress-container { width: min(80%, 420px); margin-top: 48px; }
    .progress-track {
      background: rgba(255,255,255,0.15);
      border-radius: 8px;
      height: 12px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-strong) 100%);
      border-radius: 8px;
      transition: width 4s linear;
    }
    #bgAnimation {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      opacity: 0.35;
      background: transparent;
    }
    @media (max-width: 768px) {
      .page { width: calc(100% - 32px); padding: 48px 24px; }
      .start-btn,
      .btn,
      .back-btn { width: 100%; }
      .progress { right: 24px; bottom: 28px; }
      .logo { top: 24px; width: 140px; }
    }
    @media (max-width: 480px) {
      h1 { font-size: 1.9rem; }
      .idle-title { font-size: 2.4rem; }
      .idle-subtitle { font-size: 1.1rem; }
    }
  </style>
</head>
<body>
    <canvas id="bgAnimation"></canvas>
    <div class="wrapper" id="wrapper">
        <!-- Idle -->
        <div class="page" id="page-idle">
            <img src="assets/liberty.png" alt="Liberty" class="logo" />
            <div class="idle-content">
                <h1 class="idle-title">Please give us feedback</h1>
                <p class="idle-subtitle">Tell us about your customer experience</p>
                <button class="start-btn" id="btnStart">Press to Start</button>
            </div>
        </div>

        <!-- Logo -->
        <!-- Phone -->
        <div class="page" id="page-phone">
            <h1>Please enter your phone number</h1>
            <input type="tel" id="phoneInput" placeholder="8 digit local number" autocomplete="tel" inputmode="numeric" maxlength="8" />
            <div class="field-error" id="phoneError" role="alert" aria-live="polite"></div>
            <button class="btn" id="btnProceed" disabled>Proceed</button>
        </div>
        <!-- Staff -->
        <div class="page" id="page-staff">
            <h1>Service interaction</h1>
            <div class="form-group">
                <label>Assisted by</label>
                <div class="staff-grid" id="staffGrid"></div>
            </div>
            <div class="form-group">
                <label for="genderSelect">Gender</label>
                <select id="genderSelect">
                    <option value="">Select gender</option>
                </select>
            </div>
            <div class="form-group">
                <label for="ageRangeSelect">Age range</label>
                <select id="ageRangeSelect">
                    <option value="">Select age range</option>
                </select>
            </div>
            <div class="form-group">
                <label for="citySelect">Residential Address City</label>
                <select id="citySelect">
                    <option value="">Select city</option>
                </select>
            </div>
            <button class="btn" id="btnServiceDetails" disabled>Continue</button>
            <button class="back-btn" id="backFromStaff">Back</button>
        </div>
        <!-- Service -->
        <div class="page" id="page-service">
            <h1>Which Liberty service were you assisted with today?</h1>
            <div class="form-group">
                <label for="serviceSelect">Service</label>
                <select id="serviceSelect">
                    <option value="">Select service</option>
                </select>
            </div>
            <div class="form-group">
                <label>Policies assisted with</label>
                <div class="checkbox-grid" id="policyOptions"></div>
                <p class="helper-text">Select all that apply.</p>
            </div>
            <button class="btn" id="btnProceedService" disabled>Continue</button>
            <button class="back-btn" id="backFromService">Back</button>
        </div>
        <!-- Satisfaction -->
        <div class="page" id="page-satisfaction">
            <h1>How satisfied are you with your recent interaction with Liberty?</h1>
            <div class="rating-options" id="optsSatisfaction"></div>
            <button class="back-btn" id="backFromSatisfaction">Back</button>
        </div>
        <!-- Time -->
        <div class="page" id="page-time">
            <h1>Was your query handled within a reasonable time?</h1>
            <div class="rating-options" id="optsTime"></div>
            <button class="back-btn" id="backFromTime">Back</button>
        </div>
        <!-- Respect -->
        <div class="page" id="page-respect">
            <h1>Did our staff treat you professionally and with respect?</h1>
            <div class="rating-options" id="optsRespect"></div>
            <button class="back-btn" id="backFromRespect">Back</button>
        </div>
        <!-- Recommend -->
        <div class="page" id="page-recommend">
            <h1>How likely are you to recommend Liberty to a friend or family member?</h1>
            <div class="recommend-options" id="optsRecommend"></div>
            <p class="recommend-note">(1 = Not at all likely &rarr; 5 = Extremely likely)</p>
            <button class="back-btn" id="backFromRecommend">Back</button>
        </div>
        <!-- Contact -->
        <div class="page" id="page-contact">
            <h1>Would you like someone to contact you about your experience?</h1>
            <div class="option-list contact" id="optsContact"></div>
            <button class="back-btn" id="backFromContact">Back</button>
        </div>
        <!-- Comment -->
        <div class="page" id="page-comment">
            <h1>Please tell us briefly what we could do better.</h1>
            <p class="text-optional">Optional</p>
            <textarea id="commentInput" placeholder="Type your feedback here..." rows="5"></textarea>
            <button class="btn" id="btnSubmitComment">Submit Feedback</button>
            <button class="back-btn" id="backFromComment">Back</button>
        </div>
        <!-- Final -->
        <div class="page final-page" id="page-final">
            <h1>Thank you for your feedback</h1>
            <p>Your input helps us improve our service.</p>
            <div class="progress-container">
                <div class="progress-track"><div class="progress-fill" id="finalProgress"></div></div>
            </div>
        </div>
        <!-- Step dots -->
        <div class="progress" id="progress">
            <div class="dot" data-step="0"></div>
            <div class="dot" data-step="1"></div>
            <div class="dot" data-step="2"></div>
            <div class="dot" data-step="3"></div>
            <div class="dot" data-step="4"></div>
            <div class="dot" data-step="5"></div>
            <div class="dot" data-step="6"></div>
            <div class="dot" data-step="7"></div>
        </div>
    </div>

        <script src="app-base.js"></script>
<script>
        (function () {
            const ratingQuestions = [
                { key: 'overall', container: 'optsSatisfaction', labels: ['😡 Very Poor', '😞 Poor', '😐 Fair', '🙂 Good', '😄 Excellent'], nextPage: 5 },
                { key: 'time', container: 'optsTime', labels: ['Not at all', 'No', 'Neutral', 'Yes, Mostly', 'Absolutely'], nextPage: 6 },
                { key: 'respect', container: 'optsRespect', labels: ['Not at all', 'No', 'Neutral', 'Yes, Mostly', 'Absolutely'], nextPage: 7 }
            ];
            const ratingColours = ['#e74c3c', '#e67e22', '#f1c40f', '#2ecc71', '#27ae60'];
            const recommendOptions = [
                { value: 1, emoji: '😡', label: 'Not at all likely' },
                { value: 2, emoji: '😞', label: 'Slightly likely' },
                { value: 3, emoji: '😐', label: 'Neutral' },
                { value: 4, emoji: '😃', label: 'Very likely' },
                { value: 5, emoji: '😊', label: 'Extremely likely' }
            ];
            const services = [
                'Policy enquiry Query',
                'Complaint',
                'Claim',
                'New policy application',
                'Payment',
                'Amendments Policy Changes',
                'Other'
            ];
            const genders = ['Female', 'Male'];
            const ageRanges = ['18 to 35', '36 to 45', 'Over 45'];
            const cityOptions = ['Maseru', 'Berea', 'Leribe', 'Botha Bothe', 'Mokhotlong', 'Thaba Tseka', 'Mafeteng', 'Mohale\u2019s Hoek', 'Qacha\u2019s Nek', 'Quthing'];
            const policyOptions = ['Retail Funeral Policy', 'Life Cover', 'Education Lagacy Plan'];
            const contactChoices = [
                { value: 'yes', label: 'Yes' },
                { value: 'no', label: 'No' }
            ];

            const pages = ['page-idle', 'page-phone', 'page-staff', 'page-service', 'page-satisfaction', 'page-time', 'page-respect', 'page-recommend', 'page-contact', 'page-comment', 'page-final'];
            const state = {
                phone: '',
                staff: null,
                staffName: null,
                staffBranchId: null,
                staffBranchName: null,
                gender: null,
                ageRange: null,
                city: null,
                service: null,
                policies: [],
                time: null,
                respect: null,
                overall: null,
                recommend: null,
                contactPreference: null,
                comment: '',
                startedAt: null,
                duration: 0
            };
            let currentIndex = 0;
            const byId = id => document.getElementById(id);

            function showPage(idx) {
                currentIndex = idx;
                pages.forEach((pid, i) => {
                    const p = byId(pid);
                    p.classList.toggle('active', i === idx);
                    p.style.removeProperty('display');
                });
                const prog = byId('progress');
                if (idx >= 2 && idx <= 9) {
                    prog.style.display = 'flex';
                    prog.querySelectorAll('.dot').forEach((d, i) => d.classList.toggle('active', i === (idx - 2)));
                } else {
                    prog.style.display = 'none';
                }
                document.body.classList.toggle('final-active', pages[idx] === 'page-final');
                if (pages[idx] === 'page-phone') setTimeout(() => byId('phoneInput').focus(), 50);
            }

            async function fetchRosterFromServer() {
                const token = localStorage.getItem('authToken');
                if (!token) return [];
                try {
                    const r = await fetch('/api/staff?active=true', { headers: { 'Authorization': 'Bearer ' + token } });
                    if (r.ok) {
                        const staff = await r.json();
                        localStorage.setItem('kiosk_staff', JSON.stringify(staff));
                        return staff.map(s => ({ id: s.id, name: s.name, photo: s.photoUrl || 'assets/icons/meh.svg', branchId: s.branchId, branchName: s.branchName }));
                    }
                } catch (e) { console.warn('Roster fetch failed', e); }
                return [];
            }

            function renderStaff(roster) {
                const host = byId('staffGrid');
                host.innerHTML = '';
                if (!roster || roster.length === 0) {
                    const empty = document.createElement('div');
                    empty.className = 'staff-card';
                    empty.textContent = 'No staff configured for this branch';
                    empty.style.cursor = 'default';
                    host.appendChild(empty);
                    return;
                }
                roster.forEach(m => {
                    const card = document.createElement('div');
                    card.className = 'staff-card';
                    card.dataset.id = m.id;
                    card.dataset.branchId = m.branchId ?? '';
                    card.dataset.branchName = m.branchName ?? '';
                    card.innerHTML = `<img src="${m.photo}" alt="${m.name}"><div class="name">${m.name}</div>`;
                    card.addEventListener('click', () => {
                        host.querySelectorAll('.staff-card').forEach(el => el.classList.remove('selected'));
                        card.classList.add('selected');
                        state.staff = m.id;
                        state.staffName = m.name;
                        state.staffBranchId = m.branchId ?? null;
                        state.staffBranchName = m.branchName ?? null;
                        updateServiceDetailsState();
                    });
                    host.appendChild(card);
                });
            }

            function renderServiceOptions() {
                const host = byId('serviceSelect');
                host.innerHTML = '<option value="">Select service</option>';
                services.forEach(service => {
                    const opt = document.createElement('option');
                    opt.value = service;
                    opt.textContent = service;
                    host.appendChild(opt);
                });
            }

            function renderPolicyOptions() {
                const host = byId('policyOptions');
                host.innerHTML = '';
                policyOptions.forEach(policy => {
                    const label = document.createElement('label');
                    label.className = 'checkbox-item';
                    const input = document.createElement('input');
                    input.type = 'checkbox';
                    input.value = policy;
                    input.addEventListener('change', () => {
                        const selections = Array.from(host.querySelectorAll('input:checked')).map(el => el.value);
                        state.policies = selections;
                    });
                    const span = document.createElement('span');
                    span.textContent = policy;
                    label.appendChild(input);
                    label.appendChild(span);
                    host.appendChild(label);
                });
            }

            function renderRatings() {
                const icons = ['angry', 'sad', 'meh', 'smile', 'laugh'];
                ratingQuestions.forEach(q => {
                    const host = byId(q.container);
                    host.innerHTML = '';
                    icons.forEach((icon, idx) => {
                        const opt = document.createElement('div');
                        opt.className = 'rating-option';
                        opt.dataset.value = idx + 1;
                        opt.innerHTML = `<img src="assets/icons/${icon}.svg" alt=""><div class="label">${q.labels[idx]}</div>`;
                        opt.style.backgroundColor = ratingColours[idx];
                        opt.style.borderColor = ratingColours[idx];
                        opt.addEventListener('click', () => {
                            state[q.key] = idx + 1;
                            host.querySelectorAll('.rating-option').forEach(o => o.classList.remove('selected'));
                            opt.classList.add('selected');
                            setTimeout(() => showPage(q.nextPage), 150);
                        });
                        host.appendChild(opt);
                    });
                });
            }

            function renderRecommendOptions() {
                const host = byId('optsRecommend');
                host.innerHTML = '';
                recommendOptions.forEach((opt, idx) => {
                    const el = document.createElement('div');
                    el.className = 'recommend-option';
                    el.dataset.value = opt.value;
                    el.innerHTML = `<span class="emoji">${opt.emoji}</span><span class="label">${opt.label}</span>`;
                    el.style.backgroundColor = ratingColours[idx];
                    el.style.borderColor = ratingColours[idx];
                    el.addEventListener('click', () => {
                        state.recommend = opt.value;
                        host.querySelectorAll('.recommend-option').forEach(o => o.classList.remove('selected'));
                        el.classList.add('selected');
                        setTimeout(() => showPage(8), 150);
                    });
                    host.appendChild(el);
                });
            }

            function renderContactOptions() {
                const host = byId('optsContact');
                host.innerHTML = '';
                contactChoices.forEach(choice => {
                    const el = document.createElement('div');
                    el.className = 'option-item';
                    el.textContent = choice.label;
                    el.addEventListener('click', () => {
                        state.contactPreference = choice.value;
                        host.querySelectorAll('.option-item').forEach(o => o.classList.remove('selected'));
                        el.classList.add('selected');
                        setTimeout(() => showPage(9), 150);
                    });
                    host.appendChild(el);
                });
            }

            function persistResponse() {
                (async () => {
                    try {
                        await fetch('/api/feedback', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                phone: state.phone,
                                staffId: state.staff,
                                staffName: state.staffName,
                                serviceType: state.service,
                                gender: state.gender,
                                ageRange: state.ageRange,
                                city: state.city,
                                policies: state.policies,
                                timeRating: state.time,
                                respectRating: state.respect,
                                overallRating: state.overall,
                                recommendRating: state.recommend,
                                contactPreference: state.contactPreference,
                                comment: state.comment,
                                startedUtc: state.startedAt ? new Date(state.startedAt).toISOString() : undefined,
                                durationSeconds: state.duration ?? 0,
                                branchId: state.staffBranchId,
                                branchName: state.staffBranchName
                            })
                        });
                    } catch (e) {
                        console.warn('Feedback submit failed', e);
                    }
                })();
            }

            function resetState() {
                state.phone = '';
                state.staff = null;
                state.staffName = null;
                state.staffBranchId = null;
                state.staffBranchName = null;
                state.gender = null;
                state.ageRange = null;
                state.city = null;
                state.service = null;
                state.policies = [];
                state.time = null;
                state.respect = null;
                state.overall = null;
                state.recommend = null;
                state.contactPreference = null;
                state.comment = '';
                state.duration = 0;
                state.startedAt = null;
                const phoneInput = byId('phoneInput');
                phoneInput.value = '';
                const phoneError = byId('phoneError');
                if (phoneError) phoneError.textContent = '';
                byId('btnProceed').disabled = true;
                ['optsSatisfaction', 'optsTime', 'optsRespect', 'optsRecommend', 'optsContact'].forEach(id => {
                    const host = byId(id);
                    if (host) host.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
                });
                const staffGrid = byId('staffGrid');
                if (staffGrid) staffGrid.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
                const genderSelect = byId('genderSelect');
                if (genderSelect) genderSelect.value = '';
                const ageRangeSelect = byId('ageRangeSelect');
                if (ageRangeSelect) ageRangeSelect.value = '';
                const citySelect = byId('citySelect');
                if (citySelect) citySelect.value = '';
                const serviceSelect = byId('serviceSelect');
                if (serviceSelect) serviceSelect.value = '';
                const policyHost = byId('policyOptions');
                if (policyHost) policyHost.querySelectorAll('input[type="checkbox"]').forEach(el => { el.checked = false; });
                const btnServiceDetails = byId('btnServiceDetails');
                if (btnServiceDetails) btnServiceDetails.disabled = true;
                const btnProceedService = byId('btnProceedService');
                if (btnProceedService) btnProceedService.disabled = true;
                const commentInput = byId('commentInput');
                if (commentInput) commentInput.value = '';
            }

            (async () => {
                const roster = await fetchRosterFromServer();
                renderStaff(roster);
                renderServiceOptions();
                renderPolicyOptions();
                renderRatings();
                renderRecommendOptions();
                renderContactOptions();
                showPage(0);
            })();

            byId('btnStart').addEventListener('click', () => {
                if (currentIndex === 0) {
                    state.startedAt = Date.now();
                    showPage(1);
                }
            });

            const phoneInput = byId('phoneInput');
            const btnProceed = byId('btnProceed');
            const phoneError = byId('phoneError');
            function validatePhone(v) {
                const digits = v.replace(/\D/g, '');
                return digits.length === 8 && digits === v;
            }
            function updatePhoneValidation(showMessage) {
                const value = phoneInput.value.trim();
                state.phone = value;
                const isValid = validatePhone(value);
                btnProceed.disabled = !isValid;
                if (!phoneError) return;
                if (!value && !showMessage) {
                    phoneError.textContent = '';
                    return;
                }
                phoneError.textContent = isValid ? '' : 'Please enter an 8 digit local phone number.';
            }
            phoneInput.addEventListener('input', () => {
                phoneInput.value = phoneInput.value.replace(/\D/g, '').slice(0, 8);
                updatePhoneValidation(false);
            });
            phoneInput.addEventListener('blur', () => {
                updatePhoneValidation(true);
            });
            phoneInput.addEventListener('keydown', ev => {
                if (ev.key === 'Enter') {
                    ev.preventDefault();
                    if (btnProceed.disabled) {
                        updatePhoneValidation(true);
                        return;
                    }
                    showPage(2);
                }
            });
            btnProceed.addEventListener('click', () => showPage(2));
            const btnServiceDetails = byId('btnServiceDetails');
            function updateServiceDetailsState() {
                if (!btnServiceDetails) return;
                btnServiceDetails.disabled = !(state.staff && state.gender && state.ageRange && state.city);
            }
            const genderSelect = byId('genderSelect');
            if (genderSelect) {
                genderSelect.innerHTML = '<option value="">Select gender</option>';
                genders.forEach(g => {
                    const opt = document.createElement('option');
                    opt.value = g;
                    opt.textContent = g;
                    genderSelect.appendChild(opt);
                });
                genderSelect.addEventListener('change', () => {
                    state.gender = genderSelect.value || null;
                    updateServiceDetailsState();
                });
            }
            const ageRangeSelect = byId('ageRangeSelect');
            if (ageRangeSelect) {
                ageRangeSelect.innerHTML = '<option value="">Select age range</option>';
                ageRanges.forEach(range => {
                    const opt = document.createElement('option');
                    opt.value = range;
                    opt.textContent = range;
                    ageRangeSelect.appendChild(opt);
                });
                ageRangeSelect.addEventListener('change', () => {
                    state.ageRange = ageRangeSelect.value || null;
                    updateServiceDetailsState();
                });
            }
            const citySelect = byId('citySelect');
            if (citySelect) {
                citySelect.innerHTML = '<option value="">Select city</option>';
                cityOptions.forEach(city => {
                    const opt = document.createElement('option');
                    opt.value = city;
                    opt.textContent = city;
                    citySelect.appendChild(opt);
                });
                citySelect.addEventListener('change', () => {
                    state.city = citySelect.value || null;
                    updateServiceDetailsState();
                });
            }
            if (btnServiceDetails) {
                btnServiceDetails.addEventListener('click', () => showPage(3));
            }
            const serviceSelect = byId('serviceSelect');
            const btnProceedService = byId('btnProceedService');
            if (serviceSelect && btnProceedService) {
                serviceSelect.addEventListener('change', () => {
                    state.service = serviceSelect.value || null;
                    btnProceedService.disabled = !state.service;
                });
                btnProceedService.addEventListener('click', () => showPage(4));
            }
            byId('backFromStaff').addEventListener('click', () => showPage(1));
            byId('backFromService').addEventListener('click', () => showPage(2));
            byId('backFromSatisfaction').addEventListener('click', () => showPage(3));
            byId('backFromTime').addEventListener('click', () => showPage(4));
            byId('backFromRespect').addEventListener('click', () => showPage(5));
            byId('backFromRecommend').addEventListener('click', () => showPage(6));
            byId('backFromContact').addEventListener('click', () => showPage(7));
            byId('backFromComment').addEventListener('click', () => showPage(8));
            byId('btnSubmitComment').addEventListener('click', () => {
                const commentInput = byId('commentInput');
                state.comment = commentInput ? commentInput.value.trim() : '';
                showPage(10);
            });

            const observer = new MutationObserver(() => {
                if (pages[currentIndex] === 'page-final') {
                    state.duration = state.startedAt ? Math.round((Date.now() - state.startedAt) / 1000) : 0;
                    persistResponse();
                    const bar = byId('finalProgress');
                    if (bar) {
                        bar.style.width = '0%';
                        setTimeout(() => { bar.style.width = '100%'; }, 50);
                    }
                    setTimeout(() => {
                        resetState();
                        showPage(0);
                    }, 4000);
                }
            });
            observer.observe(byId('page-final'), { attributes: true, attributeFilter: ['class'] });
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register(appBuildUrl('sw.js')).catch(() => { });
            }
        })();

        const canvas = document.getElementById('bgAnimation');
        const ctx = canvas.getContext('2d');
        let w, h;
        function resize() {
            w = canvas.width = window.innerWidth;
            h = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        let particles = [];
        for (let i = 0; i < 60; i++) {
            particles.push({
                x: Math.random() * w,
                y: Math.random() * h,
                angle: Math.random() * Math.PI * 2,
                radius: 50 + Math.random() * 150,
                speed: 0.002 + Math.random() * 0.003
            });
        }

        function animate() {
            ctx.clearRect(0, 0, w, h);
            ctx.strokeStyle = "rgba(63,183,255,0.3)";
            ctx.lineWidth = 1.5;
            ctx.beginPath();
            particles.forEach(p => {
                p.angle += p.speed;
                const px = p.x + Math.cos(p.angle) * p.radius;
                const py = p.y + Math.sin(p.angle) * p.radius;
                ctx.lineTo(px, py);
            });
            ctx.stroke();
            requestAnimationFrame(animate);
        }
        animate();

    </script>
</body>
</html>
