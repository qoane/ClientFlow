<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Liberty NPS Survey</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <style>
        :root {
            --brand: #de2b2b
        }

        .nps button {
            min-width: 42px
        }
    </style>
</head>
<body class="bg-body-tertiary">

    <main class="container py-4">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="p-4 bg-white border rounded">
                    <h3 id="title" class="mb-2">Survey</h3>
                    <p id="desc" class="text-secondary"></p>
                    <form id="form"></form>
                    <div id="alert" class="alert alert-success mt-3 d-none">Thanks for your feedback!</div>
                </div>
            </div>
        </div>
    </main>

    <script src="api.js"></script>
    <script>
(async function(){
  const code = new URLSearchParams(location.search).get('code') || 'liberty-nps';
  const s = await API.getSurvey(code);

  document.getElementById('title').textContent = s.title;
  if(s.description) document.getElementById('desc').textContent = s.description;

  const form = document.getElementById('form');

  // build controls from questions (only NPS + reason for seed)
  for(const q of s.questions.sort((a,b)=>a.order-b.order)){
    const wrap = document.createElement('div'); wrap.className='mb-3';
    const label = document.createElement('label'); label.className='form-label fw-semibold'; label.textContent = q.prompt + (q.required?' *':'');
    wrap.appendChild(label);

    if(q.type === 'nps_0_10'){
      const row = document.createElement('div'); row.className='d-flex gap-2 flex-wrap nps';
      for(let i=0;i<=10;i++){
        const id = `${q.key}-${i}`;
        row.insertAdjacentHTML('beforeend',
          `<input class="btn-check" type="radio" name="${q.key}" id="${id}" value="${i}" ${q.required?'required':''}>
           <label class="btn btn-outline-secondary" for="${id}">${i}</label>`);
      }
      wrap.appendChild(row);
      wrap.insertAdjacentHTML('beforeend',
        `<div class="d-flex justify-content-between small text-muted mt-1">
           <span>Not at all likely</span><span>Extremely likely</span>
         </div>`);
    }
    else if(q.type === 'text'){
      const ta = document.createElement('textarea');
      ta.className = 'form-control';
      try{ const set = JSON.parse(q.settingsJson||'{}'); if(set.placeholder) ta.placeholder = set.placeholder; }catch{}
      if(q.required) ta.required = true;
      ta.name = q.key;
      wrap.appendChild(ta);
    }
    // (extend more types as you add to the DB)
    form.appendChild(wrap);
  }

  const btn = document.createElement('button');
  btn.type='submit'; btn.className='btn btn-primary'; btn.textContent='Submit';
  form.appendChild(btn);

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const data = {};
    for(const q of s.questions){
      const el = form.elements[q.key];
      if(!el) continue;
      if(q.type==='nps_0_10'){
        const sel = form.querySelector(`input[name="${q.key}"]:checked`);
        data[q.key] = sel ? sel.value : null;
      }else{
        data[q.key] = el.value ?? null;
      }
    }
    await API.submit(s.code, data);
    document.getElementById('alert').classList.remove('d-none');
    form.reset();
  });
})();
    </script>
</body>
</html>
