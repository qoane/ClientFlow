<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Liberty NPS Survey</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <style>
        :root {
            --accent: #19cba0;
            --accent-soft: rgba(25, 203, 160, 0.18);
            --panel: #0f1530;
            --panel-strong: rgba(13, 26, 74, 0.86);
            --text: #eef1ff;
            --muted: #9fb0ff;
            --border: rgba(255, 255, 255, 0.12);
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
        }

        body {
            margin: 0;
            font: 16px/1.55 "Segoe UI", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            color: var(--text);
            background: radial-gradient(1100px 700px at 80% -10%, rgba(33, 59, 118, 0.55), transparent 60%), #0b1020;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 32px 18px;
        }

        main.container {
            width: 100%;
            max-width: 980px;
            padding: 0;
        }

        .survey-shell {
            background: var(--panel-strong);
            border: 1px solid var(--border);
            border-radius: 26px;
            padding: 40px;
            box-shadow: 0 35px 80px rgba(8, 14, 34, 0.55);
        }

        h3#title {
            font-size: 2.1rem;
            margin-bottom: 0.35rem;
        }

        #desc {
            color: var(--muted);
            margin-bottom: 1.75rem;
        }

        .section-head {
            font-size: 1.35rem;
            font-weight: 700;
            margin-bottom: 16px;
            color: #cfe0ff;
        }

        .cf-form .row {
            margin-bottom: 24px;
        }

        label.form-label {
            display: block;
            color: var(--text);
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 1.05rem;
        }

        input,
        select,
        textarea {
            width: 100%;
            display: block;
            color: var(--text);
            background: rgba(17, 26, 60, 0.72);
            border: 1px solid rgba(255, 255, 255, 0.16);
            border-radius: 14px;
            padding: 12px 14px;
            min-height: 50px;
            transition: border-color .18s ease, box-shadow .18s ease;
        }

        input:focus,
        select:focus,
        textarea:focus {
            border-color: var(--accent);
            outline: none;
            box-shadow: 0 0 0 3px rgba(25, 203, 160, 0.22);
        }

        textarea {
            min-height: 140px;
        }

        .btn {
            border-radius: 14px;
            border: none;
            font-weight: 600;
            letter-spacing: .015em;
            padding: 14px 32px;
            min-height: 52px;
            transition: transform .12s ease, filter .12s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #19cba0, #5df5d1);
            color: #05261f;
        }

        .btn-primary:hover {
            filter: brightness(1.05);
            transform: translateY(-1px);
        }

        #prev.btn {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.28);
            color: var(--text);
        }

        #prev.btn:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .nps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(54px, 1fr));
            gap: 10px;
        }

        .nps button {
            border-radius: 14px;
            min-width: auto;
            border: 1px solid rgba(255, 255, 255, 0.14);
            background: rgba(22, 32, 72, 0.7);
            color: var(--text);
            font-weight: 600;
            padding: 14px 0;
            transition: transform .12s ease, background .12s ease;
        }

        .nps button:hover,
        .nps button.selected {
            background: var(--accent);
            color: #05261f;
            transform: translateY(-2px);
        }

        .rating-stars {
            display: flex;
            gap: 14px;
            flex-wrap: wrap;
        }

        .rating-stars button {
            width: 66px;
            height: 66px;
            border-radius: 18px;
            border: 1px solid rgba(255, 255, 255, 0.16);
            background: rgba(20, 30, 68, 0.7);
            font-size: 1.9rem;
            color: rgba(255, 255, 255, 0.45);
            cursor: pointer;
            transition: transform .12s ease, background .12s ease, color .12s ease;
        }

        .rating-stars button.selected {
            background: var(--accent);
            color: #031b15;
            transform: translateY(-3px);
        }

        .rating-stars button:focus-visible {
            outline: 3px solid rgba(255, 255, 255, 0.32);
            outline-offset: 2px;
        }

        .survey-alert {
            margin-top: 24px;
        }

        @media (max-width: 720px) {
            body {
                padding: 18px;
            }

            .survey-shell {
                padding: 26px;
                border-radius: 20px;
            }

            .rating-stars button {
                width: 58px;
                height: 58px;
            }
        }
    </style>
</head>
<body class="bg-body-tertiary">

    <main class="container py-4">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="survey-shell">
                    <h3 id="title" class="mb-2">Survey</h3>
                    <p id="desc" class="text-secondary"></p>
                    <form id="form"></form>
                    <div id="alert" class="alert alert-success survey-alert d-none">Thanks for your feedback!</div>
                </div>
            </div>
        </div>
    </main>

        <script src="app-base.js"></script>
<script src="api.js"></script>
    <script>
(async function(){
  const code = new URLSearchParams(location.search).get('code') || 'liberty-nps';
  const titleEl = document.getElementById('title');
  const descEl = document.getElementById('desc');
  const form = document.getElementById('form');
  const alertEl = document.getElementById('alert');

  let sessionStarted = Date.now();

  const parseSettings = (json) => {
    if(!json) return {};
    try { return JSON.parse(json); } catch { return {}; }
  };

  try {
    const [survey, definition] = await Promise.all([
      API.getSurvey(code).catch(() => null),
      API.getSurveyDefinition(code)
    ]);

    const surveyCode = definition?.code ?? survey?.code ?? code;
    const surveyTitle = definition?.title ?? survey?.title ?? 'Survey';
    titleEl.textContent = surveyTitle;
    if (survey?.description) {
      descEl.textContent = survey.description;
    }

    const sections = [...(definition?.sections ?? [])].sort((a, b) => a.order - b.order);
    const questions = [...(definition?.questions ?? [])].sort((a, b) => a.order - b.order);
    const optionsMap = new Map();
    for (const opt of definition?.options ?? []) {
      const list = optionsMap.get(opt.questionId) ?? [];
      list.push(opt);
      optionsMap.set(opt.questionId, list);
    }
    for (const list of optionsMap.values()) {
      list.sort((a, b) => a.order - b.order);
    }

    const sectionsToRender = sections.length > 0 ? sections : [{ id: null, title: null, order: 0 }];

    for (const section of sectionsToRender) {
      const sectionQuestions = questions.filter(q => (q.sectionId ?? null) === (section.id ?? null));
      if (sectionQuestions.length === 0) continue;

      const block = document.createElement('div');
      block.className = 'mb-4';
      if (section.title) {
        const head = document.createElement('h5');
        head.className = 'section-head';
        head.textContent = section.title;
        block.appendChild(head);
      }

      for (const q of sectionQuestions) {
        const wrap = document.createElement('div');
        wrap.className = 'mb-3';

        const label = document.createElement('label');
        label.className = 'form-label fw-semibold';
        label.textContent = q.prompt + (q.required ? ' *' : '');
        wrap.appendChild(label);

        if (q.type === 'message') {
          label.classList.add('d-none');
          const note = document.createElement('div');
          note.className = 'alert alert-info mb-0';
          note.textContent = q.prompt;
          wrap.appendChild(note);
          block.appendChild(wrap);
          continue;
        }

        if (q.type === 'nps_0_10') {
          const row = document.createElement('div');
          row.className = 'd-flex gap-2 flex-wrap nps';
          for (let i = 0; i <= 10; i++) {
            const id = `${q.key}-${i}`;
            const input = document.createElement('input');
            input.className = 'btn-check';
            input.type = 'radio';
            input.name = q.key;
            input.id = id;
            input.value = String(i);
            if (q.required && i === 0) input.required = true;
            const lbl = document.createElement('label');
            lbl.className = 'btn btn-outline-secondary';
            lbl.setAttribute('for', id);
            lbl.textContent = String(i);
            row.appendChild(input);
            row.appendChild(lbl);
          }
          wrap.appendChild(row);
          const scale = document.createElement('div');
          scale.className = 'd-flex justify-content-between small text-muted mt-1';
          scale.innerHTML = '<span>Not at all likely</span><span>Extremely likely</span>';
          wrap.appendChild(scale);
        }
        else if (q.type === 'rating_stars' || q.type === 'rating') {
          const settings = parseSettings(q.settingsJson);
          const maxStars = Number(settings.stars) > 0 ? Number(settings.stars) : 5;
          const defaultValue = settings.defaultValue ? Number(settings.defaultValue) : null;
          const hidden = document.createElement('input');
          hidden.type = 'hidden';
          hidden.name = q.key;
          if (q.required) {
            hidden.dataset.required = 'true';
          }

          const holder = document.createElement('div');
          holder.className = 'rating-stars';
          const update = (value) => {
            Array.from(holder.children).forEach(btn => {
              const v = Number(btn.dataset.value);
              btn.classList.toggle('selected', v <= value);
              btn.setAttribute('aria-pressed', v <= value ? 'true' : 'false');
            });
          };

          for (let i = 1; i <= maxStars; i++) {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.dataset.value = String(i);
            btn.textContent = '★';
            btn.addEventListener('click', () => {
              hidden.value = String(i);
              update(i);
            });
            holder.appendChild(btn);
          }

          if (defaultValue) {
            hidden.value = String(defaultValue);
            update(defaultValue);
          }

          wrap.appendChild(holder);
          wrap.appendChild(hidden);
        }
        else if (q.type === 'radio') {
          const opts = optionsMap.get(q.id) ?? [];
          const group = document.createElement('div');
          group.className = 'd-flex flex-column gap-2';
          opts.forEach((opt, idx) => {
            const check = document.createElement('div');
            check.className = 'form-check';
            const input = document.createElement('input');
            input.type = 'radio';
            input.className = 'form-check-input';
            input.name = q.key;
            input.id = `${q.key}-${idx}`;
            input.value = opt.value;
            if (q.required && idx === 0) input.required = true;
            const lbl = document.createElement('label');
            lbl.className = 'form-check-label';
            lbl.setAttribute('for', input.id);
            lbl.textContent = opt.label;
            check.appendChild(input);
            check.appendChild(lbl);
            group.appendChild(check);
          });
          wrap.appendChild(group);
        }
        else if (q.type === 'text') {
          const input = document.createElement('input');
          input.type = 'text';
          input.className = 'form-control';
          const settings = parseSettings(q.settingsJson);
          if (settings.placeholder) input.placeholder = settings.placeholder;
          if (q.required) input.required = true;
          input.name = q.key;
          wrap.appendChild(input);
        }
        else if (q.type === 'phone') {
          const input = document.createElement('input');
          input.type = 'tel';
          input.inputMode = 'tel';
          input.className = 'form-control';
          if (q.required) input.required = true;
          input.name = q.key;
          wrap.appendChild(input);
        }
        else if (q.type === 'textarea') {
          const ta = document.createElement('textarea');
          ta.className = 'form-control';
          const settings = parseSettings(q.settingsJson);
          if (settings.placeholder) ta.placeholder = settings.placeholder;
          if (q.required) ta.required = true;
          ta.name = q.key;
          wrap.appendChild(ta);
        }
        else {
          const input = document.createElement('input');
          input.type = 'text';
          input.className = 'form-control';
          if (q.required) input.required = true;
          input.name = q.key;
          wrap.appendChild(input);
        }

        block.appendChild(wrap);
      }

      form.appendChild(block);
    }

    const btn = document.createElement('button');
    btn.type = 'submit';
    btn.className = 'btn btn-primary';
    btn.textContent = 'Submit';
    form.appendChild(btn);

    const questionsForSubmit = questions.filter(q => q.type !== 'message');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = {};
      for (const q of questionsForSubmit) {
        const el = form.elements[q.key];
        if (!el) continue;
        if (typeof RadioNodeList !== 'undefined' && el instanceof RadioNodeList) {
          data[q.key] = el.value ? el.value : null;
        } else if (el.length && el[0]?.type === 'radio') {
          const selected = Array.from(el).find(input => input.checked);
          data[q.key] = selected ? selected.value : null;
        } else {
          data[q.key] = el.value ?? null;
        }
      }
      data.__startedUtc = new Date(sessionStarted).toISOString();
      data.__durationSeconds = String(Math.max(0, Math.round((Date.now() - sessionStarted) / 1000)));

      for (const q of questionsForSubmit) {
        if (q.required) {
          const value = data[q.key];
          if (value == null || (typeof value === 'string' && value.trim() === '')) {
            alertEl.classList.remove('d-none');
            alertEl.classList.remove('alert-success');
            alertEl.classList.add('alert-danger');
            alertEl.textContent = `Please complete "${q.prompt}" before continuing.`;
            return;
          }
        }
      }
      await API.submit(surveyCode, data);
      alertEl.classList.remove('alert-danger');
      alertEl.classList.add('alert-success');
      alertEl.classList.remove('d-none');
      alertEl.textContent = 'Thanks for your feedback!';
      form.reset();
      sessionStarted = Date.now();
    });
  } catch (err) {
    console.error(err);
    form.innerHTML = '<div class="alert alert-danger">Unable to load survey at this time.</div>';
  }
})();
    </script>
</body>
</html>
