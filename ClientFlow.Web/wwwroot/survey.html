<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Liberty NPS Survey</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <style>
        :root {
            --brand: #de2b2b
        }

        .nps button {
            min-width: 42px
        }
    </style>
</head>
<body class="bg-body-tertiary">

    <main class="container py-4">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="p-4 bg-white border rounded">
                    <h3 id="title" class="mb-2">Survey</h3>
                    <p id="desc" class="text-secondary"></p>
                    <form id="form"></form>
                    <div id="alert" class="alert alert-success mt-3 d-none">Thanks for your feedback!</div>
                </div>
            </div>
        </div>
    </main>

        <script src="app-base.js"></script>
<script src="api.js"></script>
    <script>
(async function(){
  const code = new URLSearchParams(location.search).get('code') || 'liberty-nps';
  const titleEl = document.getElementById('title');
  const descEl = document.getElementById('desc');
  const form = document.getElementById('form');
  const alertEl = document.getElementById('alert');

  const parseSettings = (json) => {
    if(!json) return {};
    try { return JSON.parse(json); } catch { return {}; }
  };

  try {
    const [survey, definition] = await Promise.all([
      API.getSurvey(code).catch(() => null),
      API.getSurveyDefinition(code)
    ]);

    const surveyCode = definition?.code ?? survey?.code ?? code;
    const surveyTitle = definition?.title ?? survey?.title ?? 'Survey';
    titleEl.textContent = surveyTitle;
    if (survey?.description) {
      descEl.textContent = survey.description;
    }

    const sections = [...(definition?.sections ?? [])].sort((a, b) => a.order - b.order);
    const questions = [...(definition?.questions ?? [])].sort((a, b) => a.order - b.order);
    const optionsMap = new Map();
    for (const opt of definition?.options ?? []) {
      const list = optionsMap.get(opt.questionId) ?? [];
      list.push(opt);
      optionsMap.set(opt.questionId, list);
    }
    for (const list of optionsMap.values()) {
      list.sort((a, b) => a.order - b.order);
    }

    const sectionsToRender = sections.length > 0 ? sections : [{ id: null, title: null, order: 0 }];

    for (const section of sectionsToRender) {
      const sectionQuestions = questions.filter(q => (q.sectionId ?? null) === (section.id ?? null));
      if (sectionQuestions.length === 0) continue;

      const block = document.createElement('div');
      block.className = 'mb-4';
      if (section.title) {
        const head = document.createElement('h5');
        head.className = 'mb-3 text-primary';
        head.textContent = section.title;
        block.appendChild(head);
      }

      for (const q of sectionQuestions) {
        const wrap = document.createElement('div');
        wrap.className = 'mb-3';

        const label = document.createElement('label');
        label.className = 'form-label fw-semibold';
        label.textContent = q.prompt + (q.required ? ' *' : '');
        wrap.appendChild(label);

        if (q.type === 'message') {
          label.classList.add('d-none');
          const note = document.createElement('div');
          note.className = 'alert alert-info mb-0';
          note.textContent = q.prompt;
          wrap.appendChild(note);
          block.appendChild(wrap);
          continue;
        }

        if (q.type === 'nps_0_10') {
          const row = document.createElement('div');
          row.className = 'd-flex gap-2 flex-wrap nps';
          for (let i = 0; i <= 10; i++) {
            const id = `${q.key}-${i}`;
            const input = document.createElement('input');
            input.className = 'btn-check';
            input.type = 'radio';
            input.name = q.key;
            input.id = id;
            input.value = String(i);
            if (q.required && i === 0) input.required = true;
            const lbl = document.createElement('label');
            lbl.className = 'btn btn-outline-secondary';
            lbl.setAttribute('for', id);
            lbl.textContent = String(i);
            row.appendChild(input);
            row.appendChild(lbl);
          }
          wrap.appendChild(row);
          const scale = document.createElement('div');
          scale.className = 'd-flex justify-content-between small text-muted mt-1';
          scale.innerHTML = '<span>Not at all likely</span><span>Extremely likely</span>';
          wrap.appendChild(scale);
        }
        else if (q.type === 'radio') {
          const opts = optionsMap.get(q.id) ?? [];
          const group = document.createElement('div');
          group.className = 'd-flex flex-column gap-2';
          opts.forEach((opt, idx) => {
            const check = document.createElement('div');
            check.className = 'form-check';
            const input = document.createElement('input');
            input.type = 'radio';
            input.className = 'form-check-input';
            input.name = q.key;
            input.id = `${q.key}-${idx}`;
            input.value = opt.value;
            if (q.required && idx === 0) input.required = true;
            const lbl = document.createElement('label');
            lbl.className = 'form-check-label';
            lbl.setAttribute('for', input.id);
            lbl.textContent = opt.label;
            check.appendChild(input);
            check.appendChild(lbl);
            group.appendChild(check);
          });
          wrap.appendChild(group);
        }
        else if (q.type === 'text') {
          const input = document.createElement('input');
          input.type = 'text';
          input.className = 'form-control';
          const settings = parseSettings(q.settingsJson);
          if (settings.placeholder) input.placeholder = settings.placeholder;
          if (q.required) input.required = true;
          input.name = q.key;
          wrap.appendChild(input);
        }
        else if (q.type === 'phone') {
          const input = document.createElement('input');
          input.type = 'tel';
          input.inputMode = 'tel';
          input.className = 'form-control';
          if (q.required) input.required = true;
          input.name = q.key;
          wrap.appendChild(input);
        }
        else if (q.type === 'textarea') {
          const ta = document.createElement('textarea');
          ta.className = 'form-control';
          const settings = parseSettings(q.settingsJson);
          if (settings.placeholder) ta.placeholder = settings.placeholder;
          if (q.required) ta.required = true;
          ta.name = q.key;
          wrap.appendChild(ta);
        }
        else {
          const input = document.createElement('input');
          input.type = 'text';
          input.className = 'form-control';
          if (q.required) input.required = true;
          input.name = q.key;
          wrap.appendChild(input);
        }

        block.appendChild(wrap);
      }

      form.appendChild(block);
    }

    const btn = document.createElement('button');
    btn.type = 'submit';
    btn.className = 'btn btn-primary';
    btn.textContent = 'Submit';
    form.appendChild(btn);

    const questionsForSubmit = questions.filter(q => q.type !== 'message');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = {};
      for (const q of questionsForSubmit) {
        const el = form.elements[q.key];
        if (!el) continue;
        if (typeof RadioNodeList !== 'undefined' && el instanceof RadioNodeList) {
          data[q.key] = el.value ? el.value : null;
        } else if (el.length && el[0]?.type === 'radio') {
          const selected = Array.from(el).find(input => input.checked);
          data[q.key] = selected ? selected.value : null;
        } else {
          data[q.key] = el.value ?? null;
        }
      }
      await API.submit(surveyCode, data);
      alertEl.classList.remove('d-none');
      form.reset();
    });
  } catch (err) {
    console.error(err);
    form.innerHTML = '<div class="alert alert-danger">Unable to load survey at this time.</div>';
  }
})();
    </script>
</body>
</html>
