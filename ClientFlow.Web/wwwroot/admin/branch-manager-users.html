<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ClientFlow — Branch Manager Created Users</title>
    <style>
        :root {
            --bg: #0b1020;
            --panel: #121936;
            --panel2: #0f1530;
            --border: rgba(255,255,255,.08);
            --muted: #9fb0ff;
            --text: #eef1ff;
            --accent: #6cf0c2;
            --accent2: #89b4ff;
            --danger: #ff6b6b;
        }
        * { box-sizing: border-box; }
        html, body { height: 100%; margin: 0; }
        body {
            background: radial-gradient(1200px 800px at 80% -10%,#1b2550 0%,transparent 60%),var(--bg);
            color: var(--text);
            font-family: system-ui,-apple-system,Segoe UI,Roboto;
            display: grid;
            grid-template-rows: 64px 1fr;
        }
        header { display:flex; align-items:center; gap:16px; padding:0 20px; border-bottom:1px solid var(--border); background:linear-gradient(180deg,#141c3f,#0e1533); }
        .brand { display:flex; align-items:center; gap:10px; font-weight:700; }
        .logo { width:28px; height:28px; border-radius:8px; background:conic-gradient(from 210deg,var(--accent),var(--accent2)); box-shadow:0 0 0 2px rgba(255,255,255,.07) inset; }
        .toolbar { margin-left:auto; }
        .toolbar button { padding:8px 12px; border-radius:10px; border:1px solid var(--border); background: linear-gradient(180deg,#1a2248,#141c3f); color: var(--text); cursor:pointer; }
        .shell { display:grid; grid-template-columns:220px 1fr; gap:12px; height:100%; }
        @media (max-width:900px){ .shell { grid-template-columns:1fr; } }
        nav { padding:12px; display:flex; flex-direction:column; gap:10px; }
        nav a { text-decoration:none; color:var(--text); padding:10px 12px; border:1px solid var(--border); border-radius:12px; background: linear-gradient(180deg,#1a2248,#141c3f); }
        nav a.active { box-shadow:0 0 0 2px #19cba044; }
        main { padding:12px; overflow-y:auto; display:grid; gap:12px; }
        .card { background: var(--panel); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.15); }
        .branch-card { display:grid; gap:14px; }
        .branch-head { display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; }
        .branch-head h2 { margin:0; font-size:20px; }
        .muted { color: var(--muted); font-size:14px; }
        .chip { display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; border:1px solid var(--border); background: rgba(12,18,44,.6); font-size:12px; color:var(--muted); }
        .manager-block { border:1px solid var(--border); border-radius:12px; padding:12px; background: var(--panel2); display:grid; gap:10px; }
        .manager-head { display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; }
        .manager-head strong { font-size:16px; }
        table { width:100%; border-collapse:collapse; }
        th,td { padding:8px 10px; border-bottom:1px solid var(--border); text-align:left; }
        th { color:var(--muted); font-size:13px; }
        tbody tr:hover { background: rgba(255,255,255,.04); }
        .empty { text-align:center; padding:40px; }
        .empty h2 { margin-top:0; }
        .loader { display:flex; justify-content:center; padding:40px 0; }
        .spinner { width:36px; height:36px; border-radius:50%; border:4px solid rgba(255,255,255,.18); border-top-color: var(--accent); animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <header>
        <div class="brand"><div class="logo"></div><div>ClientFlow</div></div>
        <div class="toolbar"><span id="userEmail" style="margin-right:16px;"></span><button id="signOut">Sign Out</button></div>
    </header>
    <div class="shell">
        <nav>
            <a href="/admin/dashboard.html">Dashboard</a>
            <a href="/admin/branches.html">Branches</a>
            <a href="/admin/users.html">Users</a>
            <a href="/admin/branch-manager-users.html" class="active">Manager Created Users</a>
            <a href="/admin/settings.html">Settings</a>
            <a href="/admin/flow-dash.html">Surveys</a>
            <a href="/kiosk-dashboard.html" target="_blank">Kiosk Dashboard</a>
        </nav>
        <main>
            <div class="card">
                <h1 style="margin:0 0 6px 0;">Users Created by Branch Managers</h1>
                <p class="muted" style="margin:0;">Super Admin overview of branch-managed user accounts grouped by their branch.</p>
            </div>
            <div id="content" class="card loader"><div class="spinner" role="status" aria-label="Loading"></div></div>
        </main>
    </div>
    <script>
        const token = localStorage.getItem('authToken');
        if (!token) { window.location.href = '/login.html'; }
        const role = localStorage.getItem('userRole');
        if (role !== 'SuperAdmin') {
            window.location.href = '/admin/users.html';
        }
        const userEmailSpan = document.getElementById('userEmail');
        if (userEmailSpan) userEmailSpan.textContent = localStorage.getItem('userEmail') || '';
        document.getElementById('signOut').addEventListener('click', () => { localStorage.clear(); window.location.href = '/login.html'; });
        const content = document.getElementById('content');
        async function api(path) {
            const res = await fetch(path, { headers: { 'Authorization': 'Bearer ' + token } });
            if (!res.ok) {
                const message = await res.text();
                throw new Error(message || 'Request failed');
            }
            return res.json();
        }
        function plural(count, word) {
            return `${count} ${word}${count === 1 ? '' : 's'}`;
        }
        function render(data) {
            if (!Array.isArray(data) || data.length === 0) {
                content.className = 'card empty';
                content.innerHTML = '<h2>No users yet</h2><p class="muted">Branch managers have not created any users.</p>';
                return;
            }
            content.className = '';
            content.innerHTML = data.map(branch => {
                const managers = branch.managers.map(manager => {
                    const rows = manager.users.map(user => `
                        <tr>
                            <td>${user.email}</td>
                            <td>${user.role}</td>
                            <td>${user.branchName || ''}</td>
                        </tr>
                    `).join('');
                    return `
                        <div class="manager-block">
                            <div class="manager-head">
                                <div>
                                    <strong>${manager.managerEmail}</strong>
                                    <div class="muted">${plural(manager.userCount, 'user')}</div>
                                </div>
                                <div class="chip">Manager ID: ${manager.managerId || '—'}</div>
                            </div>
                            <div style="overflow-x:auto;">
                                <table>
                                    <thead><tr><th>Email</th><th>Role</th><th>Branch</th></tr></thead>
                                    <tbody>${rows}</tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }).join('');
                return `
                    <section class="card branch-card">
                        <div class="branch-head">
                            <div>
                                <h2>${branch.branchName}</h2>
                                <div class="muted">${plural(branch.totalUsers, 'user')} created</div>
                            </div>
                            <div class="chip">Branch ID: ${branch.branchId || '—'}</div>
                        </div>
                        ${managers}
                    </section>
                `;
            }).join('');
        }
        async function init() {
            try {
                const data = await api('/api/users/branch-manager-created');
                render(data);
            } catch (err) {
                content.className = 'card empty';
                content.innerHTML = `<h2>Unable to load data</h2><p class="muted">${err.message}</p>`;
            }
        }
        init();
    </script>
</body>
</html>
