<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ClientFlow – Admin / Surveys</title>
    <style>
        :root {
            --bg: #0b1020;
            --panel: #121936;
            --panel2: #0f1530;
            --border: rgba(255,255,255,.08);
            --text: #eef1ff;
            --muted: #9fb0ff;
            --accent: #6cf0c2;
        }

        * {
            box-sizing: border-box
        }

        html, body {
            height: 100%
        }

        body {
            margin: 0;
            background: radial-gradient(1200px 800px at 80% -10%, #1b2550 0%, transparent 60%), var(--bg);
            color: var(--text);
            font: 14px/1.45 system-ui,-apple-system,Segoe UI,Roboto
        }

        header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border)
        }

        .logo {
            width: 24px;
            height: 24px;
            border-radius: 8px;
            background: conic-gradient(from 210deg, var(--accent), #89b4ff)
        }

        .tag {
            padding: 2px 8px;
            border: 1px solid var(--border);
            border-radius: 999px;
            color: #b9c6ff;
            font-size: 12px
        }

        .shell {
            max-width: 1000px;
            margin: 18px auto;
            padding: 0 12px;
            display: grid;
            gap: 14px
        }

        .panel {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,.15)
        }

        .head {
            padding: 12px 14px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center
        }

        .body {
            padding: 12px 14px
        }

        .row {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap
        }

        input[type=text], textarea {
            width: 100%;
            padding: 8px 10px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--panel2);
            color: var(--text)
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: linear-gradient(180deg,#1a2248,#141c3f);
            color: #e9eeff;
            cursor: pointer
        }

            .btn.accent {
                background: linear-gradient(180deg,#19cba0,#0dbb93);
                color: #031b15;
                border: none
            }

        table {
            width: 100%;
            border-collapse: collapse
        }

        th, td {
            padding: 10px;
            border-bottom: 1px solid var(--border);
            vertical-align: middle
        }

        th {
            color: #b9c6ff;
            font-weight: 600;
            text-align: left
        }

        .pill {
            padding: 2px 8px;
            border-radius: 999px;
            border: 1px solid var(--border);
            font-size: 12px
        }

        .muted {
            color: #b9c6ff
        }

        .right {
            margin-left: auto
        }
    </style>
</head>
<body>
    <header>
        <div class="logo"></div>
        <strong>ClientFlow — Admin</strong>
        <span class="tag">Surveys</span>
        <a class="btn right" href="/admin/designer.html">Open Designer →</a>
    </header>

    <main class="shell">
        <!-- CREATE -->
        <section class="panel">
            <div class="head"><strong>Create Survey</strong><span class="muted">Code must be unique</span></div>
            <div class="body">
                <div class="row">
                    <div style="flex:1 1 200px">
                        <label class="muted">Code</label>
                        <input id="code" type="text" placeholder="e.g. LIBERTY-2025">
                    </div>
                    <div style="flex:2 1 300px">
                        <label class="muted">Title</label>
                        <input id="title" type="text" placeholder="Liberty NPS 2025">
                    </div>
                </div>
                <div style="margin-top:8px">
                    <label class="muted">Description (optional)</label>
                    <textarea id="desc" rows="2" placeholder=""></textarea>
                </div>
                <div style="margin-top:10px" class="row">
                    <button class="btn accent" id="btnCreate">Create</button>
                    <span id="createMsg" class="muted"></span>
                </div>
            </div>
        </section>

        <!-- LIST -->
        <section class="panel">
            <div class="head"><strong>Surveys</strong><span class="muted" id="total"></span></div>
            <div class="body">
                <table id="grid">
                    <thead>
                        <tr>
                            <th style="width:160px">Code</th>
                            <th>Title</th>
                            <th style="width:110px">Status</th>
                            <th style="width:240px">Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>
    </main>

        <script src="../app-base.js"></script>
<script>
    const $ = (sel, el=document)=>el.querySelector(sel);
    const gridBody = $('#grid tbody');
    const totalLbl = $('#total');
    const token = localStorage.getItem('authToken');
    if (!token) {
      window.location.href = appBuildUrl('login.html');
    }
    const authHeaders = token ? { 'Authorization': 'Bearer ' + token } : {};

    async function api(path, opts={}) {
      const headers = Object.assign({ 'Content-Type': 'application/json' }, authHeaders, opts.headers || {});
      const response = await appApiFetch(path, { ...opts, headers });
      if (!response.ok) throw new Error(await response.text());
      return response.status === 204 ? null : response.json();
    }

    async function load() {
      const rows = await api('/api/admin/surveys');
      totalLbl.textContent = rows.length + ' total';
      gridBody.innerHTML = rows.map(r => tr(r)).join('');
      wireRows();
    }

    function tr(r) {
      const status = r.isActive ? `<span class="pill" style="color:#031b15;background:#19cba0">Active</span>`
                                : `<span class="pill">Inactive</span>`;
      return `<tr data-code="${r.code}">
        <td><code>${escapeHtml(r.code)}</code></td>
        <td>${escapeHtml(r.title)}</td>
        <td>${status}</td>
        <td class="row">
          <button class="btn" data-act="open">Open</button>
          <button class="btn" data-act="toggle">${r.isActive ? 'Deactivate' : 'Activate'}</button>
          <button class="btn" data-act="edit">Rename</button>
        </td>
      </tr>`;
    }

    function wireRows() {
      gridBody.querySelectorAll('tr').forEach(row => {
        row.addEventListener('click', async (e) => {
          const btn = e.target.closest('button'); if (!btn) return;
          const code = row.dataset.code;
          const act  = btn.dataset.act;

          if (act === 'open') {
            // Open runner for quick test
            window.open(`/surveys/runner.html?code=${encodeURIComponent(code)}`, '_blank');
          }
          if (act === 'toggle') {
            const isActive = btn.textContent === 'Activate';
            await api(`/api/admin/surveys/${encodeURIComponent(code)}/active`, {
              method:'PUT', body: JSON.stringify({ isActive })
            });
            await load();
          }
          if (act === 'edit') {
            const title = prompt('New title:'); if (!title) return;
            await api(`/api/admin/surveys/${encodeURIComponent(code)}`, {
              method:'PUT', body: JSON.stringify({ title })
            });
            await load();
          }
        });
      });
    }

    $('#btnCreate').addEventListener('click', async () => {
      const code = $('#code').value.trim();
      const title = $('#title').value.trim();
      const description = $('#desc').value.trim();
      const msg = $('#createMsg');

      if (!code || !title) { msg.textContent = 'Code and Title are required.'; return; }
      msg.textContent = 'Creating…';
      try {
        await api('/api/admin/surveys', { method:'POST', body: JSON.stringify({ code, title, description }) });
        $('#code').value = ''; $('#title').value = ''; $('#desc').value = '';
        msg.textContent = 'Created ✓';
        await load();
      } catch (err) {
        msg.textContent = 'Failed: ' + (''+err.message).substring(0,140);
      }
    });

    function escapeHtml(s){ return (s ?? '').replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])) }

    load();
    </script>
</body>
</html>
