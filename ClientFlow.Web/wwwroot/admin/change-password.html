<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ClientFlow — Change Password</title>
    <style>
        :root {
            --bg: #0b1020;
            --panel: #121936;
            --panel2: #0f1530;
            --border: rgba(255,255,255,.08);
            --muted: #9fb0ff;
            --text: #eef1ff;
            --accent: #6cf0c2;
            --danger: #ff6b6b;
        }
        * { box-sizing: border-box; }
        html, body { height: 100%; margin: 0; }
        body {
            background: radial-gradient(1200px 800px at 80% -10%,#1b2550 0%,transparent 60%),var(--bg);
            color: var(--text);
            font-family: system-ui,-apple-system,Segoe UI,Roboto;
            display: grid;
            grid-template-rows: 64px 1fr;
        }
        header { display:flex; align-items:center; gap:16px; padding:0 20px; border-bottom:1px solid var(--border); background:linear-gradient(180deg,#141c3f,#0e1533); }
        .brand { display:flex; align-items:center; gap:10px; font-weight:700; }
        .logo { width:28px; height:28px; border-radius:8px; background:conic-gradient(from 210deg,var(--accent),#89b4ff); box-shadow:0 0 0 2px rgba(255,255,255,.07) inset; }
        .toolbar { margin-left:auto; display:flex; align-items:center; gap:12px; font-size:14px; }
        .toolbar button { padding:8px 12px; border-radius:10px; border:1px solid var(--border); background: linear-gradient(180deg,#1a2248,#141c3f); color: var(--text); cursor:pointer; }
        main { display:flex; justify-content:center; padding:24px; overflow-y:auto; }
        .card { max-width:440px; width:100%; background: var(--panel); border:1px solid var(--border); border-radius:16px; padding:24px; box-shadow:0 10px 30px rgba(0,0,0,.15); }
        h1 { margin-top:0; }
        p.muted { color: var(--muted); font-size:14px; }
        form label { display:block; font-size:12px; color: var(--muted); margin-top:12px; }
        form input { width:100%; padding:10px 12px; margin-top:4px; border-radius:10px; border:1px solid var(--border); background:var(--panel2); color:var(--text); }
        form button { margin-top:16px; width:100%; padding:10px; border:none; border-radius:10px; background:linear-gradient(180deg,#19cba0,#0dbb93); color:#031b15; font-weight:600; cursor:pointer; }
        button.secondary { width:100%; margin-top:12px; padding:10px; border-radius:10px; border:1px solid var(--border); background: linear-gradient(180deg,#1a2248,#141c3f); color: var(--text); cursor:pointer; }
        .alert { margin-top:12px; border-radius:10px; padding:12px; font-size:14px; }
        .alert.info { background:rgba(108,240,194,.12); border:1px solid rgba(108,240,194,.35); }
        .alert.error { background:rgba(255,107,107,.12); border:1px solid rgba(255,107,107,.35); color:var(--danger); }
        .alert.success { background:rgba(108,240,194,.12); border:1px solid rgba(108,240,194,.35); }
        #codeCountdown { font-size:12px; color:var(--muted); display:block; margin-top:6px; }
    </style>
</head>
<body>
    <header>
        <div class="brand"><div class="logo"></div><div>ClientFlow</div></div>
        <div class="toolbar"><span id="userEmail"></span><button id="signOut">Sign Out</button></div>
    </header>
    <main>
        <div class="card">
            <h1>Change Password</h1>
            <p class="muted" id="introText">For security we need to verify your identity before you can update your password.</p>
            <button id="requestCode" class="secondary" type="button">Send Verification Code</button>
            <span id="codeCountdown" style="display:none"></span>
            <div id="requestStatus" class="alert info" style="display:none"></div>
            <form id="changeForm">
                <label for="currentPassword">Current Password <span style="color:var(--muted); font-weight:400;">(optional when using a verification code)</span></label>
                <input type="password" id="currentPassword" autocomplete="current-password" />
                <label for="code">Verification Code</label>
                <input type="text" id="code" autocomplete="one-time-code" inputmode="numeric" pattern="[0-9]{6}" required />
                <label for="newPassword">New Password</label>
                <input type="password" id="newPassword" autocomplete="new-password" required />
                <label for="confirmPassword">Confirm New Password</label>
                <input type="password" id="confirmPassword" autocomplete="new-password" required />
                <button type="submit">Change Password</button>
            </form>
            <div id="formStatus" class="alert" style="display:none"></div>
        </div>
    </main>
    <script src="../app-base.js"></script>
    <script>
        const token = localStorage.getItem('authToken');
        if (!token) {
            window.location.href = appBuildUrl('login.html');
        }
        const userEmail = localStorage.getItem('userEmail');
        if (userEmail) {
            document.getElementById('userEmail').textContent = userEmail;
        }
        document.getElementById('signOut').addEventListener('click', () => {
            localStorage.clear();
            window.location.href = appBuildUrl('login.html');
        });

        const mustChange = localStorage.getItem('mustChangePassword') === '1';
        if (mustChange) {
            document.getElementById('introText').textContent = 'Your administrator has requested that you change your password before continuing.';
        }

        const requestButton = document.getElementById('requestCode');
        const countdown = document.getElementById('codeCountdown');
        const requestStatus = document.getElementById('requestStatus');
        const formStatus = document.getElementById('formStatus');
        let cooldownTimer = null;
        let cooldownRemaining = 0;

        function updateCountdown() {
            if (cooldownRemaining <= 0) {
                requestButton.disabled = false;
                countdown.style.display = 'none';
                clearInterval(cooldownTimer);
                cooldownTimer = null;
                return;
            }
            countdown.style.display = '';
            countdown.textContent = `You can request a new code in ${cooldownRemaining}s.`;
            cooldownRemaining -= 1;
        }

        async function requestCode() {
            requestButton.disabled = true;
            requestStatus.style.display = 'none';
            formStatus.style.display = 'none';
            try {
                const res = await appApiFetch('api/users/me/change-password/request', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (!res.ok && res.status !== 204) {
                    throw new Error(await res.text());
                }
                requestStatus.className = 'alert info';
                requestStatus.textContent = 'Verification code sent. Check your email and enter the 6-digit code below.';
                requestStatus.style.display = '';
                cooldownRemaining = 60;
                updateCountdown();
                if (cooldownTimer) clearInterval(cooldownTimer);
                cooldownTimer = setInterval(updateCountdown, 1000);
            } catch (err) {
                requestButton.disabled = false;
                requestStatus.className = 'alert error';
                requestStatus.textContent = err.message || 'Unable to send verification code.';
                requestStatus.style.display = '';
            }
        }

        requestButton.addEventListener('click', requestCode);

        document.getElementById('changeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            formStatus.style.display = 'none';
            const currentPassword = document.getElementById('currentPassword').value;
            const code = document.getElementById('code').value.trim();
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            if (newPassword !== confirmPassword) {
                formStatus.className = 'alert error';
                formStatus.textContent = 'New passwords do not match.';
                formStatus.style.display = '';
                return;
            }
            const payload = { currentPassword, newPassword, code };
            try {
                const res = await appApiFetch('api/users/me/change-password', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!res.ok && res.status !== 204) {
                    throw new Error(await res.text());
                }
                formStatus.className = 'alert success';
                formStatus.textContent = 'Password updated successfully. Redirecting…';
                formStatus.style.display = '';
                localStorage.removeItem('mustChangePassword');
                setTimeout(() => {
                    window.location.href = appBuildUrl('admin/dashboard.html');
                }, 1500);
            } catch (err) {
                formStatus.className = 'alert error';
                formStatus.textContent = err.message || 'Unable to change password.';
                formStatus.style.display = '';
            }
        });

        if (mustChange) {
            requestCode();
        }
    </script>
</body>
</html>
